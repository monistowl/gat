name: Comprehensive CI

# Consolidated workflow for:
# - Feature matrix testing (automatic on PR to main, or manual)
# - Subcrate tests (manual dispatch only)
# - Full build matrix with diagnostics (nightly + manual)
#
# Replaces: cli-feature-matrix.yml, feature-subcrate-tests.yml,
#           staging-diagnostics.yml, nightly-full-build.yml

on:
  pull_request:
    branches: ["main"]
    paths-ignore:
      - 'website/**'
      - '**.md'
      - 'docs/**'
      - '.github/workflows/deploy-website.yml'
  schedule:
    # Nightly at 6am UTC - runs full build matrix
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      run_feature_matrix:
        description: 'Run CLI feature matrix tests'
        required: false
        type: boolean
        default: true
      run_subcrate_tests:
        description: 'Run subcrate tests (gat-core, gat-io, gat-algo, etc.)'
        required: false
        type: boolean
        default: false
      run_build_matrix:
        description: 'Run full build matrix (all OS/variants)'
        required: false
        type: boolean
        default: false
      verbose_diagnostics:
        description: 'Enable verbose compiler output'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================
  # Feature Matrix Tests
  # Runs: on PR, on manual dispatch (if enabled), NOT on schedule
  # ============================================================
  feature-matrix:
    name: Feature Matrix (${{ matrix.matrix-name }})
    runs-on: ubuntu-latest
    # Run on PR, or manual dispatch with feature_matrix enabled
    # Skip on schedule (nightly runs build-matrix instead)
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_feature_matrix)
    strategy:
      fail-fast: false
      matrix:
        include:
          - matrix-name: minimal
            features: minimal
          - matrix-name: full-io
            features: minimal,full-io
          - matrix-name: full-io+viz
            features: minimal,full-io,viz
          - matrix-name: all-backends
            features: all-backends
          - matrix-name: all-backends+gpu
            features: all-backends,gpu

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: feature-matrix-${{ matrix.matrix-name }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coinor-libcbc-dev

      - name: Run ${{ matrix.matrix-name }} tests
        run: |
          set -euo pipefail
          cargo test -p gat-cli --locked --no-default-features --features "${{ matrix.features }}" -- --nocapture

  # ============================================================
  # Subcrate Tests
  # Runs: manual dispatch only (when enabled)
  # ============================================================
  subcrate-tests:
    name: Subcrate (${{ matrix.matrix-name }})
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.run_subcrate_tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - matrix-name: gat-core
            args: "-p gat-core"
            features: ""
          - matrix-name: gat-io-full
            args: "-p gat-io"
            features: full
          - matrix-name: gat-algo-full
            args: "-p gat-algo"
            features: full
          - matrix-name: gat-ts-full
            args: "-p gat-ts"
            features: full
          - matrix-name: gat-viz
            args: "-p gat-viz"
            features: ""

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: subcrate-${{ matrix.matrix-name }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coinor-libcbc-dev

      - name: Run tests for ${{ matrix.matrix-name }}
        env:
          TEST_ARGS: ${{ matrix.args }}
          TEST_FEATURES: ${{ matrix.features }}
        run: |
          set -euo pipefail
          features_flag=""
          if [[ -n "$TEST_FEATURES" ]]; then
            features_flag="--features $TEST_FEATURES"
          fi
          cargo test $TEST_ARGS --locked $features_flag -- --nocapture

  # ============================================================
  # Full Build Matrix
  # Runs: nightly schedule, or manual dispatch (when enabled)
  # ============================================================
  build-matrix:
    name: Build Matrix
    # Run on schedule (nightly), or manual dispatch with build_matrix enabled
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_build_matrix)
    uses: ./.github/workflows/build-matrix.yml
    with:
      verbose_diagnostics: ${{ inputs.verbose_diagnostics || false }}
      upload_artifacts: true

  # ============================================================
  # Summary
  # ============================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [feature-matrix, subcrate-tests, build-matrix]
    if: always()
    steps:
      - name: Download diagnostics (if build matrix ran)
        if: needs.build-matrix.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          path: diagnostics
          pattern: build-diagnostics-*
        continue-on-error: true

      - name: Generate summary
        env:
          # Use env vars for all github context to avoid injection risks
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          FEATURE_MATRIX_RESULT: ${{ needs.feature-matrix.result }}
          SUBCRATE_RESULT: ${{ needs.subcrate-tests.result }}
          BUILD_MATRIX_RESULT: ${{ needs.build-matrix.result }}
        run: |
          echo "## Comprehensive CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** $EVENT_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** $REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** $COMMIT_SHA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Feature Matrix | ${FEATURE_MATRIX_RESULT:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| Subcrate Tests | ${SUBCRATE_RESULT:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Matrix | ${BUILD_MATRIX_RESULT:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show interpretation
          echo "### Status Key" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **success** - All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- **failure** - One or more tests failed" >> $GITHUB_STEP_SUMMARY
          echo "- **skipped** - Job was not triggered for this run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # If nightly, add next steps
          if [[ "$EVENT_NAME" == "schedule" ]]; then
            echo "### Nightly Build" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This was an automated nightly build with verbose diagnostics." >> $GITHUB_STEP_SUMMARY
            echo "Artifacts are retained for 14 days." >> $GITHUB_STEP_SUMMARY
          fi

          # If manual with build matrix, add release guidance
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]] && [[ "$BUILD_MATRIX_RESULT" == "success" ]]; then
            echo "### Next Steps (Pre-Release)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All diagnostics passed. To proceed with release:" >> $GITHUB_STEP_SUMMARY
            echo "1. Run Manual Release Build workflow to create packages" >> $GITHUB_STEP_SUMMARY
            echo "2. Test the packages locally" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge to main and tag the release" >> $GITHUB_STEP_SUMMARY
          fi
