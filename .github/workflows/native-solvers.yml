name: Native Solvers CI

# Tests the native solver plugin system:
# - Builds wrapper crates (gat-ipopt, gat-highs, etc.)
# - Tests solver registration and state management
# - Verifies IPC protocol with mock problems
# - Tests the xtask solver build/install flow

on:
  push:
    branches: [ "main", "staging", "experimental" ]
    paths:
      - 'crates/gat-solver-common/**'
      - 'crates/gat-ipopt/**'
      - 'crates/gat-cli/src/install/**'
      - 'crates/gat-cli/src/commands/solver.rs'
      - 'crates/gat-algo/src/opf/dispatch.rs'
      - 'crates/gat-algo/src/opf/mod.rs'
      - 'xtask/**'
      - 'vendor/**'
      - '.github/workflows/native-solvers.yml'
  pull_request:
    branches: [ "main", "staging", "experimental" ]
    paths:
      - 'crates/gat-solver-common/**'
      - 'crates/gat-ipopt/**'
      - 'crates/gat-cli/src/install/**'
      - 'crates/gat-cli/src/commands/solver.rs'
      - 'crates/gat-algo/src/opf/dispatch.rs'
      - 'crates/gat-algo/src/opf/mod.rs'
      - 'xtask/**'
      - 'vendor/**'
      - '.github/workflows/native-solvers.yml'
  workflow_dispatch:
    inputs:
      build_with_ipopt_sys:
        description: 'Build with actual IPOPT library (requires libipopt-dev)'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Build and test wrapper crates (stub mode - no actual solver libs)
  wrapper-crates:
    name: Build solver wrapper crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: native-solvers

      - name: Build gat-solver-common
        run: cargo build -p gat-solver-common --release

      - name: Test gat-solver-common
        run: cargo test -p gat-solver-common --release

      - name: Build gat-ipopt (stub mode)
        run: cargo build -p gat-ipopt --release

      - name: Test gat-ipopt (stub mode)
        run: cargo test -p gat-ipopt --release

      - name: Verify gat-ipopt binary exists
        run: |
          test -f target/release/gat-ipopt
          ./target/release/gat-ipopt --version || true

      - name: Upload gat-ipopt binary
        uses: actions/upload-artifact@v4
        with:
          name: gat-ipopt-stub
          path: target/release/gat-ipopt
          retention-days: 7

  # Job 2: Test solver registration and state management
  solver-state:
    name: Test solver state management
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: native-solvers

      - name: Test solver state module
        run: |
          cargo test -p gat-cli --features minimal -- solvers_state --nocapture

      - name: Test solver CLI commands
        run: |
          cargo test -p gat-cli --features minimal -- solver --nocapture

  # Job 3: Test xtask solver build/install flow
  xtask-flow:
    name: Test xtask solver workflow
    runs-on: ubuntu-latest
    needs: wrapper-crates
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gfortran \
            libblas-dev \
            liblapack-dev \
            pkg-config

      - name: Cache vendored build
        uses: actions/cache@v4
        with:
          path: vendor/local
          key: coinor-xtask-${{ runner.os }}-${{ hashFiles('vendor/*.zip', 'vendor/*.tar.gz', 'scripts/build-*.sh') }}

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: native-solvers

      - name: Build IPOPT from vendored sources
        run: ./scripts/build-ipopt.sh

      - name: Build xtask
        run: cargo build -p xtask --release

      - name: List available solvers
        run: cargo xtask solver list

      - name: Build and install gat-ipopt via xtask
        run: cargo xtask solver build ipopt --install
        env:
          PKG_CONFIG_PATH: ${{ github.workspace }}/vendor/local/lib/pkgconfig
          LD_LIBRARY_PATH: ${{ github.workspace }}/vendor/local/lib

      - name: Verify installation
        run: |
          echo "=== Checking installed binary ==="
          test -f ~/.gat/solvers/gat-ipopt
          ls -la ~/.gat/solvers/

          echo "=== Checking registration ==="
          test -f ~/.gat/config/solvers.toml
          cat ~/.gat/config/solvers.toml

          echo "=== Testing binary startup ==="
          timeout 2 ~/.gat/solvers/gat-ipopt --version || true
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/vendor/local/lib

      - name: Test gat-cli sees installed solver
        run: |
          cargo build -p gat-cli --release --features minimal
          ./target/release/gat-cli solver list 2>&1 | tee solver-list.txt

          # Verify ipopt shows as [installed]
          grep -q "\[installed\]" solver-list.txt || (echo "FAIL: IPOPT not showing as installed" && exit 1)
          echo "SUCCESS: IPOPT properly registered"
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/vendor/local/lib

  # Job 4: Test solver dispatch logic and native-dispatch integration
  solver-dispatch:
    name: Test solver dispatch
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: native-solvers

      - name: Run dispatch tests (base)
        run: cargo test -p gat-algo solver_dispatch --release -- --nocapture

      - name: Run dispatch tests with native-dispatch feature
        run: cargo test -p gat-algo solver_dispatch --release --features native-dispatch -- --nocapture

      - name: Run native-dispatch integration tests
        run: |
          # Run all tests in native_dispatch.rs (except ignored ones)
          # Ignored tests require actual solver binaries to be built
          cargo test -p gat-algo --release --features native-dispatch --test native_dispatch -- --nocapture

  # Job 5: IPC protocol verification
  ipc-protocol:
    name: Test IPC protocol
    runs-on: ubuntu-latest
    needs: wrapper-crates
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: native-solvers

      - name: Build gat-ipopt
        run: cargo build -p gat-ipopt --release

      - name: Test IPC handshake
        run: |
          # Start solver in background, capture startup message
          timeout 3 ./target/release/gat-ipopt 2>&1 | head -5 || true

      - name: Run IPC integration tests
        run: cargo test -p gat-solver-common ipc --release -- --nocapture

  # Job 6: Build with actual IPOPT (optional, requires libipopt-dev)
  real-ipopt:
    name: Build with real IPOPT
    runs-on: ubuntu-latest
    if: inputs.build_with_ipopt_sys == true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install IPOPT dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coinor-libipopt-dev pkg-config

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: native-solvers-ipopt

      - name: Build gat-ipopt with ipopt-sys
        run: cargo build -p gat-ipopt --release --features ipopt-sys

      - name: Test gat-ipopt with real IPOPT
        run: cargo test -p gat-ipopt --release --features ipopt-sys

      - name: Verify IPOPT is actually linked
        run: |
          ldd ./target/release/gat-ipopt | grep -i ipopt || echo "Warning: IPOPT not dynamically linked"
          ./target/release/gat-ipopt --version 2>&1 || true

      - name: Upload real gat-ipopt binary
        uses: actions/upload-artifact@v4
        with:
          name: gat-ipopt-real
          path: target/release/gat-ipopt
          retention-days: 7

  # Job 7: Verify vendored packages integrity
  # This job verifies COIN-OR source packages are present and valid.
  # vendor/ is tracked in git and should always be available in CI.
  vendored-packages:
    name: Verify vendored packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check critical vendored packages exist
        run: |
          echo "=== Checking critical vendored packages ==="

          # vendor/ is tracked in git - fail if missing
          if [ ! -d "vendor" ]; then
            echo "ERROR: vendor/ directory not present"
            echo "This should not happen - vendor/ is tracked in git"
            exit 1
          fi

          # Critical packages for native solver support
          CRITICAL_PACKAGES=(
            "Ipopt-stable-3.14.zip"
            "HiGHS-master.zip"
            "Cbc-master.zip"
            "Clp-master.zip"
            "CoinUtils-master.zip"
            "Osi-master.zip"
            "Cgl-master.zip"
            "ThirdParty-Metis-stable-2.0.zip"
            "ThirdParty-Mumps-stable-3.0.zip"
            "metis-4.0.3.tar.gz"
            "MUMPS_5.8.1.tar.gz"
          )

          MISSING=0
          for pkg in "${CRITICAL_PACKAGES[@]}"; do
            if [ -f "vendor/$pkg" ]; then
              SIZE=$(stat -f%z "vendor/$pkg" 2>/dev/null || stat -c%s "vendor/$pkg")
              echo "✓ $pkg (${SIZE} bytes)"
            else
              echo "✗ MISSING: $pkg"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "FAIL: $MISSING critical packages missing"
            exit 1
          fi

          echo "SUCCESS: All critical packages present"

      - name: Verify packages are valid zip archives
        run: |
          echo "=== Validating zip archive integrity ==="

          # vendor/ is tracked in git - this check is redundant but defensive
          if [ ! -d "vendor" ]; then
            echo "ERROR: vendor/ directory not present"
            exit 1
          fi

          # Test that critical packages can be unzipped
          CRITICAL_PACKAGES=(
            "Ipopt-stable-3.14.zip"
            "HiGHS-master.zip"
            "Cbc-master.zip"
          )

          for pkg in "${CRITICAL_PACKAGES[@]}"; do
            echo "Testing $pkg..."
            if unzip -t "vendor/$pkg" > /dev/null 2>&1; then
              echo "✓ $pkg is a valid zip"
            else
              echo "✗ $pkg is corrupted or invalid"
              exit 1
            fi
          done

          echo "SUCCESS: All critical packages are valid archives"

      - name: Extract and verify IPOPT structure
        run: |
          echo "=== Verifying IPOPT package structure ==="

          # vendor/ is tracked in git - this check is redundant but defensive
          if [ ! -d "vendor" ]; then
            echo "ERROR: vendor/ directory not present"
            exit 1
          fi

          mkdir -p /tmp/ipopt-test
          unzip -q vendor/Ipopt-stable-3.14.zip -d /tmp/ipopt-test

          # Check for expected IPOPT source files
          if [ -d "/tmp/ipopt-test/Ipopt-stable-3.14" ]; then
            echo "✓ IPOPT root directory found"

            # Check for critical IPOPT files
            EXPECTED_FILES=(
              "src/Common/IpTypes.hpp"
              "src/Interfaces/IpTNLP.hpp"
              "configure"
            )

            for f in "${EXPECTED_FILES[@]}"; do
              if [ -f "/tmp/ipopt-test/Ipopt-stable-3.14/$f" ]; then
                echo "✓ Found $f"
              else
                echo "✗ Missing $f"
                exit 1
              fi
            done
          else
            echo "✗ IPOPT root directory not found"
            ls /tmp/ipopt-test/
            exit 1
          fi

          echo "SUCCESS: IPOPT package structure verified"

  # Job 8: Build from vendored sources (full offline build)
  # This tests that all COIN-OR libraries can be built without network access
  vendored-build:
    name: Build from vendored sources
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gfortran \
            libblas-dev \
            liblapack-dev \
            libbz2-dev \
            zlib1g-dev \
            pkg-config

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: vendored-build

      - name: Cache vendored build
        uses: actions/cache@v4
        with:
          path: vendor/local
          key: coinor-vendored-${{ runner.os }}-${{ hashFiles('vendor/*.zip', 'vendor/*.tar.gz', 'scripts/build-*.sh') }}

      - name: Build CLP from vendored sources
        run: ./scripts/build-clp.sh

      - name: Build CBC from vendored sources
        run: ./scripts/build-cbc.sh

      - name: Verify built libraries
        run: |
          echo "=== Checking built libraries ==="
          ls -la vendor/local/lib/
          test -f vendor/local/lib/libCoinUtils.a
          test -f vendor/local/lib/libOsi.a
          test -f vendor/local/lib/libClp.a
          test -f vendor/local/lib/libCgl.a
          test -f vendor/local/lib/libCbc.a
          echo "SUCCESS: All COIN-OR libraries built"

      - name: Build gat-clp against vendored libraries
        run: cargo build -p gat-clp --release
        env:
          PKG_CONFIG_PATH: ${{ github.workspace }}/vendor/local/lib/pkgconfig

      - name: Build gat-cbc against vendored libraries
        run: cargo build -p gat-cbc --release
        env:
          PKG_CONFIG_PATH: ${{ github.workspace }}/vendor/local/lib/pkgconfig

      - name: Verify solver binaries
        run: |
          test -f target/release/gat-clp
          test -f target/release/gat-cbc
          echo "SUCCESS: Solver binaries built from vendored sources"

  # Job 9: Build IPOPT from vendored sources (macOS + Linux)
  vendored-ipopt:
    name: Build IPOPT (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gfortran \
            libblas-dev \
            liblapack-dev \
            libbz2-dev \
            zlib1g-dev \
            pkg-config

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc lapack pkg-config zlib readline || true
          # Homebrew's GCC installs gfortran as gfortran-14 (or similar version)
          # The configure scripts look for 'gfortran', so we create a symlink
          GCC_VERSION=$(brew list --versions gcc | grep -oE '[0-9]+' | head -1)
          if [ -n "$GCC_VERSION" ] && [ -f "$(brew --prefix)/bin/gfortran-$GCC_VERSION" ]; then
            sudo ln -sf "$(brew --prefix)/bin/gfortran-$GCC_VERSION" /usr/local/bin/gfortran
            echo "Created gfortran symlink pointing to gfortran-$GCC_VERSION"
          fi
          # Verify gfortran is available
          which gfortran && gfortran --version || echo "Warning: gfortran not found"

      - name: Cache vendored build
        uses: actions/cache@v4
        with:
          path: vendor/local
          key: coinor-build-${{ runner.os }}-${{ hashFiles('vendor/*.zip', 'vendor/*.tar.gz', 'scripts/build-*.sh') }}

      - name: Build CLP from vendored sources
        run: ./scripts/build-clp.sh

      - name: Build CBC from vendored sources
        run: ./scripts/build-cbc.sh

      - name: Build IPOPT from vendored sources
        run: ./scripts/build-ipopt.sh

      - name: Verify all COIN-OR installations
        run: |
          echo "=== Verifying COIN-OR libraries ==="
          # CLP stack
          test -f vendor/local/lib/libCoinUtils.a && echo "✓ libCoinUtils.a"
          test -f vendor/local/lib/libOsi.a && echo "✓ libOsi.a"
          test -f vendor/local/lib/libClp.a && echo "✓ libClp.a"
          # CBC stack
          test -f vendor/local/lib/libCgl.a && echo "✓ libCgl.a"
          test -f vendor/local/lib/libCbc.a && echo "✓ libCbc.a"
          # IPOPT stack
          test -f vendor/local/lib/libcoinmetis.a && echo "✓ libcoinmetis.a"
          test -f vendor/local/lib/libcoinmumps.a && echo "✓ libcoinmumps.a"
          (test -f vendor/local/lib/libipopt.so || test -f vendor/local/lib/libipopt.dylib) && echo "✓ libipopt"
          echo "SUCCESS: All COIN-OR libraries built from vendored sources on ${{ runner.os }}"

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: vendored-ipopt-${{ runner.os }}

      - name: Build gat-clp against vendored libraries
        # Force vendored libs by setting PKG_CONFIG_PATH exclusively (no system paths)
        # This ensures we test the vendored build, not system pkg-config detection
        run: PKG_CONFIG_PATH="" cargo build -p gat-clp --release
        env:
          # Also set LD_LIBRARY_PATH for runtime library lookup during build tests
          LD_LIBRARY_PATH: ${{ github.workspace }}/vendor/local/lib

      - name: Build gat-cbc against vendored libraries
        run: PKG_CONFIG_PATH="" cargo build -p gat-cbc --release
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/vendor/local/lib

      - name: Build gat-ipopt with ipopt-sys
        run: cargo build -p gat-ipopt --release --features ipopt-sys
        env:
          PKG_CONFIG_PATH: ${{ github.workspace }}/vendor/local/lib/pkgconfig
          LD_LIBRARY_PATH: ${{ github.workspace }}/vendor/local/lib

      - name: Verify all solver binaries
        if: runner.os == 'Linux'
        run: |
          echo "=== Verifying solver binaries ==="
          test -f target/release/gat-clp && echo "✓ gat-clp built"
          test -f target/release/gat-cbc && echo "✓ gat-cbc built"
          test -f target/release/gat-ipopt && echo "✓ gat-ipopt built"
          ldd target/release/gat-ipopt | grep ipopt && echo "✓ gat-ipopt linked against vendored IPOPT"
          echo "SUCCESS: All solver binaries built from vendored sources"

  # Summary job
  summary:
    name: Native Solvers Summary
    runs-on: ubuntu-latest
    needs: [wrapper-crates, solver-state, xtask-flow, solver-dispatch, ipc-protocol, vendored-packages, vendored-build, vendored-ipopt]
    if: always()
    steps:
      - name: Check results
        env:
          WRAPPER_RESULT: ${{ needs.wrapper-crates.result }}
          STATE_RESULT: ${{ needs.solver-state.result }}
          XTASK_RESULT: ${{ needs.xtask-flow.result }}
          DISPATCH_RESULT: ${{ needs.solver-dispatch.result }}
          IPC_RESULT: ${{ needs.ipc-protocol.result }}
          VENDOR_PKG_RESULT: ${{ needs.vendored-packages.result }}
          VENDOR_BUILD_RESULT: ${{ needs.vendored-build.result }}
          VENDOR_IPOPT_RESULT: ${{ needs.vendored-ipopt.result }}
        run: |
          echo "=== Native Solvers CI Summary ==="
          echo ""
          echo "Core jobs:"
          echo "  wrapper-crates: $WRAPPER_RESULT"
          echo "  solver-state: $STATE_RESULT"
          echo "  xtask-flow: $XTASK_RESULT"
          echo "  solver-dispatch: $DISPATCH_RESULT"
          echo "  ipc-protocol: $IPC_RESULT"
          echo ""
          echo "Vendored build jobs:"
          echo "  vendored-packages: $VENDOR_PKG_RESULT"
          echo "  vendored-build: $VENDOR_BUILD_RESULT"
          echo "  vendored-ipopt: $VENDOR_IPOPT_RESULT"

          # Core jobs must pass
          if [ "$WRAPPER_RESULT" != "success" ] || \
             [ "$STATE_RESULT" != "success" ] || \
             [ "$XTASK_RESULT" != "success" ] || \
             [ "$DISPATCH_RESULT" != "success" ] || \
             [ "$IPC_RESULT" != "success" ]; then
            echo "FAIL: One or more core jobs failed"
            exit 1
          fi

          # Vendored build jobs should pass - this validates full offline build capability
          if [ "$VENDOR_PKG_RESULT" != "success" ]; then
            echo "WARN: vendored-packages job failed"
          fi
          if [ "$VENDOR_BUILD_RESULT" != "success" ]; then
            echo "WARN: vendored-build job failed (CLP/CBC from source)"
          fi
          if [ "$VENDOR_IPOPT_RESULT" != "success" ]; then
            echo "WARN: vendored-ipopt job failed (IPOPT from source)"
          fi

          echo ""
          echo "SUCCESS: All core native solver tests passed"
