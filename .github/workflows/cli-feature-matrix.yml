name: CLI Feature Matrix

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  cli-feature-matrix:
    name: gat-cli feature matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - matrix-name: minimal
            features: minimal
          - matrix-name: full-io
            features: minimal,full-io
          - matrix-name: full-io+viz
            features: minimal,full-io,viz
          - matrix-name: all-backends
            features: all-backends

    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ hashFiles('Cargo.lock') }}

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y coinor-libcbc-dev

      - name: Run ${{ matrix.matrix-name }} gat-cli tests
        run: |
          set -euo pipefail
          cargo test -p gat-cli --locked --no-default-features --features "${{ matrix.features }}" -- --nocapture
