name: Create GitHub Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-packages:
    name: "Build release packages (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        variant: [headless, analyst, full]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y coinor-libcbc-dev jq libssl-dev pkg-config

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install coinor-cbc jq openssl pkg-config || true

      - name: Build ${{ matrix.variant }} variant
        run: |
          scripts/package.sh "${{ matrix.variant }}"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}-${{ matrix.variant }}-${{ github.ref_name }}
          path: dist/*.tar.gz
          retention-days: 90
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-packages
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: release-*

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find release-artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ github.ref_name }}"

          # Extract version from tag (remove 'v' prefix)
          CLEAN_VERSION="${VERSION#v}"

          # Get commits since last tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          cat > release-notes.md <<EOF
          # GAT ${CLEAN_VERSION}

          **Grid Analysis Toolkit** - High-performance power systems analysis in Rust

          ## Installation

          ### Quick Install (Linux/macOS)

          \`\`\`bash
          # Headless (minimal dependencies)
          curl -fsSL https://github.com/monistowl/gat/releases/download/${VERSION}/gat-${CLEAN_VERSION}-linux-x86_64-headless.tar.gz | tar xz
          cd gat-${CLEAN_VERSION}-linux-x86_64-headless
          ./install.sh

          # Or for macOS
          curl -fsSL https://github.com/monistowl/gat/releases/download/${VERSION}/gat-${CLEAN_VERSION}-darwin-x86_64-headless.tar.gz | tar xz
          cd gat-${CLEAN_VERSION}-darwin-x86_64-headless
          ./install.sh
          \`\`\`

          ### Available Variants

          - **headless** - Core CLI functionality, minimal dependencies
          - **analyst** - Includes ADMS, DERMS, analytics, and feature engineering
          - **full** - All features including GUI and TUI (when available)

          ## What's Changed

          EOF

          if [[ -n "$PREVIOUS_TAG" ]]; then
            echo "### Changes since ${PREVIOUS_TAG}" >> release-notes.md
            echo "" >> release-notes.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> release-notes.md
          else
            echo "Initial release" >> release-notes.md
          fi

          cat >> release-notes.md <<EOF


          ## Documentation

          - **Website:** https://monistowl.github.io/gat/
          - **Docs:** https://monistowl.github.io/gat/docs/
          - **Repository:** https://github.com/monistowl/gat

          ## Packages

          EOF

          find release-assets -name "*.tar.gz" -exec basename {} \; | sort | while read pkg; do
            echo "- \`${pkg}\`" >> release-notes.md
          done

          echo "" >> release-notes.md
          echo "**Full Changelog**: https://github.com/monistowl/gat/compare/${PREVIOUS_TAG}...${VERSION}" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: release-notes.md
          files: release-assets/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: false  # We're providing custom notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Created Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find release-assets -name "*.tar.gz" -exec basename {} \; | sort | while read pkg; do
            echo "- \`$pkg\`" >> $GITHUB_STEP_SUMMARY
          done
