name: Staging Diagnostics

on:
  workflow_dispatch:
    inputs:
      verbose_diagnostics:
        description: 'Enable verbose compiler output'
        required: false
        type: boolean
        default: false
      run_feature_matrix:
        description: 'Run CLI feature matrix tests'
        required: false
        type: boolean
        default: true
      run_subcrate_tests:
        description: 'Run subcrate tests'
        required: false
        type: boolean
        default: true
      run_build_matrix:
        description: 'Run full build matrix (all OS/variants)'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # Feature matrix testing
  feature-matrix:
    name: Feature Matrix Tests
    if: inputs.run_feature_matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - matrix-name: minimal
            features: minimal
          - matrix-name: full-io
            features: minimal,full-io
          - matrix-name: full-io+viz
            features: minimal,full-io,viz
          - matrix-name: all-backends
            features: all-backends
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: feature-matrix-${{ matrix.matrix-name }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coinor-libcbc-dev

      - name: Run ${{ matrix.matrix-name }} tests
        run: |
          set -euo pipefail
          cargo test -p gat-cli --locked --no-default-features --features "${{ matrix.features }}" -- --nocapture

  # Subcrate testing
  subcrate-tests:
    name: Subcrate Tests
    if: inputs.run_subcrate_tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - matrix-name: gat-core
            args: "-p gat-core"
            features: ""
          - matrix-name: gat-io-full
            args: "-p gat-io"
            features: full
          - matrix-name: gat-algo-full
            args: "-p gat-algo"
            features: full
          - matrix-name: gat-ts-full
            args: "-p gat-ts"
            features: full
          - matrix-name: gat-viz
            args: "-p gat-viz"
            features: ""
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: subcrate-${{ matrix.matrix-name }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coinor-libcbc-dev

      - name: Run tests for ${{ matrix.matrix-name }}
        run: |
          set -euo pipefail
          features_flag=""
          if [[ -n "${{ matrix.features }}" ]]; then
            features_flag="--features ${{ matrix.features }}"
          fi
          cargo test ${{ matrix.args }} --locked $features_flag -- --nocapture

  # Full build matrix
  build-matrix:
    name: Build Matrix
    if: inputs.run_build_matrix
    uses: ./.github/workflows/build-matrix.yml
    with:
      verbose_diagnostics: ${{ inputs.verbose_diagnostics }}
      upload_artifacts: true

  # Comprehensive summary
  summary:
    name: Diagnostic Summary
    runs-on: ubuntu-latest
    needs: [feature-matrix, subcrate-tests, build-matrix]
    if: always()
    steps:
      - name: Download all diagnostics
        if: inputs.run_build_matrix
        uses: actions/download-artifact@v4
        with:
          path: diagnostics
          pattern: build-diagnostics-*

      - name: Generate comprehensive summary
        run: |
          echo "## Staging Diagnostics Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.run_feature_matrix }}" == "true" ]]; then
            echo "**Feature Matrix:** ${{ needs.feature-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ inputs.run_subcrate_tests }}" == "true" ]]; then
            echo "**Subcrate Tests:** ${{ needs.subcrate-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ inputs.run_build_matrix }}" == "true" ]]; then
            echo "**Build Matrix:** ${{ needs.build-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Interpretation Guide" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **success**: All tests passed ✅" >> $GITHUB_STEP_SUMMARY
          echo "- **failure**: One or more tests failed ❌" >> $GITHUB_STEP_SUMMARY
          echo "- **cancelled**: Tests were cancelled ⚠️" >> $GITHUB_STEP_SUMMARY
          echo "- **skipped**: Tests were not run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -d diagnostics ]]; then
            echo "### Build Diagnostics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Diagnostic files available in artifacts:" >> $GITHUB_STEP_SUMMARY
            find diagnostics -name "*.json" -exec basename {} \; | sort | while read diag; do
              echo "- \`$diag\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If all diagnostics show **success**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run \`Manual Release Build\` workflow to create packages" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the packages locally" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge staging → main" >> $GITHUB_STEP_SUMMARY
          echo "4. Tag the release on main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If any diagnostics show **failure**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the failed job logs for details" >> $GITHUB_STEP_SUMMARY
          echo "2. Download diagnostic artifacts for analysis" >> $GITHUB_STEP_SUMMARY
          echo "3. Fix issues on staging before proceeding" >> $GITHUB_STEP_SUMMARY
