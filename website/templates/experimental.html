{% extends "base.html" %}

{% block title %}{{ page.title }} | {{ config.title }}{% endblock title %}
{% block description %}{{ page.description }}{% endblock description %}

{% block extra_head %}
<style>
  :root {
    --exp-bg: radial-gradient(circle at 20% 20%, rgba(248, 113, 113, 0.1), transparent 35%),
              radial-gradient(circle at 80% 0%, rgba(59, 130, 246, 0.12), transparent 30%),
              linear-gradient(135deg, #0f172a, #0b1220 60%, #0a0f1c);
    --panel: rgba(15, 23, 42, 0.8);
    --panel-stroke: rgba(148, 163, 184, 0.2);
    --accent: #f97316;
    --muted: #cbd5e1;
    --code: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
  }

  body {
    background: var(--exp-bg);
    background-attachment: fixed;
  }

  .exp-hero {
    border: 1px solid var(--panel-stroke);
    border-radius: 14px;
    padding: 1.6rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
    box-shadow: 0 18px 60px rgba(0,0,0,0.35);
  }

  .pill {
    display: inline-flex;
    gap: 0.35rem;
    align-items: center;
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid var(--panel-stroke);
    font-size: 0.85rem;
    color: var(--muted);
  }

  .grid {
    display: grid;
    grid-template-columns: 280px 1.1fr 1fr;
    gap: 1rem;
  }

  .card {
    background: var(--panel);
    border: 1px solid var(--panel-stroke);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 12px 36px rgba(0,0,0,0.22);
  }

  .section-title {
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 0.4rem;
  }

  .badge {
    border-radius: 6px;
    padding: 0.2rem 0.55rem;
    font-size: 0.75rem;
    background: rgba(249, 115, 22, 0.12);
    color: #fdba74;
    border: 1px solid rgba(249, 115, 22, 0.35);
  }

  .stub-input {
    width: 100%;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--panel-stroke);
    color: white;
    border-radius: 10px;
    padding: 0.65rem 0.75rem;
    font-family: var(--code);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.65rem 1rem;
    border-radius: 10px;
    border: 1px solid rgba(249, 115, 22, 0.35);
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.18), rgba(249, 115, 22, 0.12));
    color: white;
    font-weight: 600;
  }

  .btn.ghost {
    background: rgba(255,255,255,0.02);
    border-color: var(--panel-stroke);
    color: var(--muted);
  }

  .stack {
    display: grid;
    gap: 0.75rem;
  }

  .signal {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 12px rgba(34,197,94,0.55);
  }

  .codebox {
    font-family: var(--code);
    background: rgba(0,0,0,0.35);
    border: 1px solid var(--panel-stroke);
    border-radius: 10px;
    padding: 0.75rem;
    color: #e2e8f0;
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 140px;
  }

  .mini-tab {
    display: inline-flex;
    gap: 0.4rem;
    align-items: center;
    padding: 0.4rem 0.7rem;
    border-radius: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--panel-stroke);
    color: white;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .mini-tab.active {
    border-color: rgba(249, 115, 22, 0.6);
    background: rgba(249, 115, 22, 0.12);
  }

  .layout-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.6rem;
    background: rgba(255,255,255,0.04);
    border-radius: 6px;
    border: 1px solid var(--panel-stroke);
  }

  .grid-ghost {
    border: 1px dashed rgba(148, 163, 184, 0.4);
    border-radius: 8px;
    padding: 0.7rem;
    color: var(--muted);
    font-size: 0.92rem;
  }

  .console {
    background: rgba(0,0,0,0.45);
    border: 1px solid var(--panel-stroke);
    border-radius: 10px;
    padding: 0.65rem;
    font-family: var(--code);
    color: #a5f3fc;
    min-height: 140px;
    max-height: 220px;
    overflow-y: auto;
    line-height: 1.4;
  }

  .prog {
    width: 100%;
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.05);
    overflow: hidden;
    border: 1px solid var(--panel-stroke);
  }
  .prog span {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, #f97316, #fb923c);
    width: 12%;
    transition: width 0.2s ease;
  }

  @media (max-width: 1100px) {
    .grid { grid-template-columns: 1fr; }
  }

  /* Extensions area */
  .extensions {
    margin-top: 1.25rem;
    display: grid;
    grid-template-columns: 1.1fr 0.9fr;
    gap: 1rem;
  }
  @media (max-width: 1100px) {
    .extensions { grid-template-columns: 1fr; }
  }

  .canvas-ghost {
    border: 1px dashed rgba(148, 163, 184, 0.45);
    border-radius: 12px;
    min-height: 220px;
    background: repeating-linear-gradient(
      45deg,
      rgba(255,255,255,0.02),
      rgba(255,255,255,0.02) 12px,
      rgba(255,255,255,0.04) 12px,
      rgba(255,255,255,0.04) 24px
    );
    color: var(--muted);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1rem;
  }

  .toolbelt {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.7rem;
    border-radius: 999px;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--panel-stroke);
    cursor: pointer;
  }

  .drag-step {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.6rem 0.75rem;
    background: rgba(255,255,255,0.03);
    border: 1px dashed var(--panel-stroke);
    border-radius: 10px;
    color: #e2e8f0;
  }

  .chiplist {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
  }
</style>
{% endblock extra_head %}

{% block content %}
<section class="container mx-auto px-4 py-8">
  <div class="exp-hero mb-8">
    <div class="flex items-center gap-3 mb-3">
      <span class="pill">
        <span class="signal"></span>
        Experimental UI Surface
      </span>
      <span class="badge">WASM stub</span>
      <span class="badge">Agent-ready</span>
    </div>
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-semibold text-white mb-2">Embedded Web Console (Prototype)</h1>
        <p class="text-slate-300 max-w-3xl">
          A scaffolded web front-end for running GAT inside the browser via WASM, MCP, or remote runners.
          No binaries are invoked yet‚Äîcontrols emit structured intents we can wire to real backends later.
        </p>
      </div>
      <div class="flex gap-3">
        <button class="btn" data-action="export-spec">
          <span>Download intent JSON</span>
        </button>
        <button class="btn ghost" data-action="open-wireframe">
          <span>View interaction map</span>
        </button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- Left rail: dataset and runner selection -->
    <div class="card stack">
      <div class="section-title">Workspace</div>
      <div class="stack">
        <label class="text-slate-200 text-sm">Dataset manifest</label>
        <input class="stub-input" data-field="manifest" value="ieee14.arrow" />
        <div class="layout-chip"><span>‚Üó</span><span>Drop file (stubbed)</span></div>
      </div>

      <div class="stack">
        <div class="section-title">Execution target</div>
        <div class="flex gap-2 flex-wrap">
          <div class="mini-tab active" data-runner="wasm">
            <span>üß©</span> In-browser WASM
          </div>
          <div class="mini-tab" data-runner="mcp">
            <span>ü§ù</span> MCP bridge
          </div>
          <div class="mini-tab" data-runner="remote">
            <span>üåê</span> Remote daemon
          </div>
        </div>
        <div class="grid-ghost">Runner config surface will appear here once a backend is wired.</div>
      </div>

      <div class="stack">
        <div class="section-title">Scenario presets</div>
        <div class="flex gap-2 flex-wrap">
          <span class="mini-tab active" data-preset="pf-dc">PF: DC</span>
          <span class="mini-tab" data-preset="pf-ac">PF: AC</span>
          <span class="mini-tab" data-preset="opf-dc">OPF: DC</span>
          <span class="mini-tab" data-preset="n1">N-1 sweep</span>
        </div>
        <p class="text-slate-400 text-sm">Presets populate the intent form; swapping between them keeps local edits.</p>
      </div>
    </div>

    <!-- Middle: intent builder -->
    <div class="card stack">
      <div class="section-title">Intent builder (stubbed)</div>
      <div class="stack">
        <label class="text-slate-200 text-sm">Command template</label>
        <input class="stub-input" data-field="template" value="gat pf dc" />
      </div>
      <div class="stack">
        <label class="text-slate-200 text-sm">Parameters</label>
        <div class="stack" data-params>
          <div class="grid grid-cols-2 gap-2">
            <input class="stub-input" value="--out flows.parquet" />
            <input class="stub-input" value="--threads 4" />
          </div>
          <div class="stub-input" contenteditable="true" data-field="notes"># add more flags or leave comments</div>
        </div>
      </div>
      <div class="flex gap-3">
        <button class="btn" data-action="preview-intent">Preview intent</button>
        <button class="btn ghost" data-action="reset">Reset</button>
        <button class="btn" data-action="simulate-run">Simulate run</button>
      </div>
    </div>

    <!-- Right: preview & wiring hints -->
    <div class="card stack">
      <div class="section-title">Preview (structured)</div>
      {% set initial_intent = '{ "status": "waiting", "runner": "wasm", "template": "gat pf dc" }' %}
      <div class="codebox" id="intent-preview">
        {{ initial_intent }}
      </div>
      <div class="stack">
        <div class="section-title">Wiring plan</div>
        <ul class="text-slate-300 text-sm space-y-1">
          <li>‚Ä¢ Bind `runner` selection to WASM loader (wasm-bindgen/worker) or MCP client.</li>
          <li>‚Ä¢ Map `template` + params ‚Üí structured intent JSON for agents.</li>
          <li>‚Ä¢ Stream stdout/stderr into this pane once backend is live.</li>
          <li>‚Ä¢ Persist last-run intent in localStorage for offline demos.</li>
        </ul>
        <div class="section-title mt-2">Simulated output</div>
        <div class="prog"><span id="sim-progress"></span></div>
        <div class="console" id="sim-console">[idle]</div>
      </div>
    </div>
  </div>
</section>

<section class="container mx-auto px-4 pb-10">
  <div class="extensions">
    <div class="card stack">
      <div class="section-title">Network sketchpad (speculative)</div>
      <div class="toolbelt">
        <span class="mini-tab active">ü™¢ Add bus</span>
        <span class="mini-tab">ü™¢ Add branch</span>
        <span class="mini-tab">‚ö° Generator</span>
        <span class="mini-tab">‚õî Contingency toggle</span>
        <span class="mini-tab">‚Ü∫ Undo</span>
        <span class="mini-tab">‚Üª Redo</span>
      </div>
      <div class="canvas-ghost">
        Canvas placeholder: drop nodes/lines, edit impedances inline, snap to GIS if enabled. Emits JSON diffs for WASM solver.
      </div>
      <div class="toolbelt">
        <span class="toggle">Auto-solve on edit</span>
        <span class="toggle">Validate topology</span>
        <span class="toggle">Show limits</span>
      </div>
    </div>

    <div class="card stack">
      <div class="section-title">GIS overlay (speculative)</div>
      <div class="stack">
        <div class="layout-chip"><span>üó∫Ô∏è</span><span>Basemap: Dark terrain</span></div>
        <div class="layout-chip"><span>üìç</span><span>Geo-join: census tracts.parquet</span></div>
        <div class="layout-chip"><span>üéØ</span><span>Layer: hosting-capacity (kW)</span></div>
      </div>
      <div class="canvas-ghost" style="min-height:180px;">
        Map stub: show buses as points, branches as lines, choropleth polygons. Toggle lasso to select subgraph and re-run intent with spatial filter.
      </div>
      <div class="toolbelt">
        <span class="toggle">Sync with sketchpad</span>
        <span class="toggle">Heatmap mode</span>
        <span class="toggle">Show outages</span>
      </div>
    </div>
  </div>

  <div class="extensions">
    <div class="card stack">
      <div class="section-title">Collab & agents</div>
      <div class="stack">
        <div class="layout-chip"><span>üë•</span><span>Live cursors (planned)</span></div>
        <div class="layout-chip"><span>ü§ñ</span><span>Agent suggestions</span></div>
        <div class="layout-chip"><span>üìù</span><span>Comment threads</span></div>
      </div>
      <div class="console" id="agent-console">Agent stream: (stub) awaiting MCP hook</div>
      <div class="toolbelt">
        <span class="toggle">Allow auto-fix proposals</span>
        <span class="toggle">Guardrails: read-only</span>
      </div>
    </div>

    <div class="card stack">
      <div class="section-title">Artifacts & checkpoints</div>
      <div class="stack">
        <div class="grid-ghost">
          When wired, runs will attach artifacts (Parquet, Arrow, SVGs) and allow diffing intents. Use this space for a run history timeline.
        </div>
      </div>
      <div class="toolbelt">
        <span class="toggle">Autosave intents</span>
        <span class="toggle">Retain artifacts</span>
        <span class="toggle">Shareable links</span>
      </div>
    </div>
  </div>

  <div class="extensions">
    <div class="card stack">
      <div class="section-title">Pipeline composer (speculative)</div>
      <div class="stack">
        <div class="drag-step">‚¨° Import MATPOWER ‚Üí grid.arrow</div>
        <div class="drag-step">‚¨° PF DC ‚Üí flows.parquet</div>
        <div class="drag-step">‚¨° N-1 sweep ‚Üí n1_results/</div>
        <div class="drag-step">‚¨° Reliability metrics ‚Üí metrics.parquet</div>
      </div>
      <div class="toolbelt">
        <span class="toggle">Parallelize</span>
        <span class="toggle">Cache artifacts</span>
        <span class="toggle">Replay with new data</span>
      </div>
      <div class="grid-ghost">Drag-to-reorder placeholder; future: export as manifest.json for batch runner or invoke via WASM pipeline scheduler.</div>
    </div>

    <div class="card stack">
      <div class="section-title">Scripting sandbox</div>
      <div class="chiplist">
        <span class="mini-tab active">WASM + JS</span>
        <span class="mini-tab">Lua (rhai?)</span>
        <span class="mini-tab">Python (pyodide)</span>
      </div>
      <div class="codebox" id="script-box">// write quick transforms here\nconst buses = await load('grid.arrow');\nreturn buses.length;</div>
      <div class="toolbelt">
        <span class="toggle">Expose gat wasm bindings</span>
        <span class="toggle">Allow fs sandbox</span>
        <span class="toggle">Share snippet</span>
      </div>
    </div>
  </div>

  <div class="extensions">
    <div class="card stack">
      <div class="section-title">Diagnostics & tuner</div>
      <div class="chiplist">
        <span class="mini-tab active">Solver traces</span>
        <span class="mini-tab">Jacobian heatmap</span>
        <span class="mini-tab">Constraint violations</span>
      </div>
      <div class="canvas-ghost" style="min-height:170px;">
        Visualization slot for iteration traces, step lengths, KKT residuals. Hook to WASM streams or MCP logs.
      </div>
      <div class="toolbelt">
        <span class="toggle">Auto-tune tolerances</span>
        <span class="toggle">Export trace</span>
      </div>
    </div>

    <div class="card stack">
      <div class="section-title">Notebook/embed</div>
      <div class="grid-ghost">
        Placeholder iframe for Observable/Marimo; lets users mix narrative + charts + embedded intent runner bound to the same WASM backend.
      </div>
      <div class="toolbelt">
        <span class="toggle">Trust notebook</span>
        <span class="toggle">Isolate environment</span>
        <span class="toggle">Share snapshot</span>
      </div>
    </div>
  </div>
</section>

<script>
(function() {
  const intentPreview = document.getElementById('intent-preview');
  const state = {
    runner: 'wasm',
    preset: 'pf-dc',
    template: 'gat pf dc',
    manifest: 'ieee14.arrow',
    params: ['--out flows.parquet', '--threads 4'],
    notes: '# add more flags or leave comments'
  };

  function updatePreview() {
    const payload = {
      version: "0.1",
      runner: state.runner,
      preset: state.preset,
      template: state.template,
      manifest: state.manifest,
      params: state.params,
      notes: state.notes,
      wiring: {
        stdout: "pending",
        stderr: "pending",
        artifacts: []
      }
    };
    intentPreview.textContent = JSON.stringify(payload, null, 2);
  }

  document.querySelectorAll('[data-runner]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-runner]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.runner = btn.getAttribute('data-runner');
      updatePreview();
    });
  });

  document.querySelectorAll('[data-preset]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.preset = btn.getAttribute('data-preset');
      // minimal preset swap
      if (state.preset === 'pf-ac') state.template = 'gat pf ac';
      else if (state.preset === 'opf-dc') state.template = 'gat opf dc';
      else if (state.preset === 'n1') state.template = 'gat nminus1 dc';
      else state.template = 'gat pf dc';
      document.querySelector('[data-field=\"template\"]').value = state.template;
      updatePreview();
    });
  });

  const manifestField = document.querySelector('[data-field=\"manifest\"]');
  manifestField.addEventListener('input', (e) => {
    state.manifest = e.target.value;
    updatePreview();
  });

  document.querySelector('[data-field=\"template\"]').addEventListener('input', (e) => {
    state.template = e.target.value;
    updatePreview();
  });

  document.querySelector('[data-field=\"notes\"]').addEventListener('input', (e) => {
    state.notes = e.target.textContent;
    updatePreview();
  });

  document.querySelector('[data-action=\"preview-intent\"]').addEventListener('click', updatePreview);
  document.querySelector('[data-action=\"reset\"]').addEventListener('click', () => {
    state.template = 'gat pf dc';
    state.params = ['--out flows.parquet', '--threads 4'];
    state.manifest = 'ieee14.arrow';
    state.notes = '# add more flags or leave comments';
    document.querySelector('[data-field=\"template\"]').value = state.template;
    document.querySelector('[data-field=\"manifest\"]').value = state.manifest;
    document.querySelector('[data-field=\"notes\"]').textContent = state.notes;
    updatePreview();
  });

  document.querySelector('[data-action=\"export-spec\"]').addEventListener('click', () => {
    const blob = new Blob([intentPreview.textContent], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'gat-intent.json';
    a.click();
  });

  document.querySelector('[data-action=\"open-wireframe\"]').addEventListener('click', () => {
    alert("Wireframe view is a placeholder. We'll swap this for a draw.io/mermaid embed when ready.");
  });

  // Simulated run loop: animates progress and pushes mock stdout lines
  const consoleEl = document.getElementById('sim-console');
  const progressEl = document.getElementById('sim-progress');
  function log(line) {
    if (consoleEl.textContent.trim() === '[idle]') consoleEl.textContent = '';
    consoleEl.textContent += line + "\\n";
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  document.querySelector('[data-action=\"simulate-run\"]').addEventListener('click', () => {
    consoleEl.textContent = '[starting wasm worker]';
    progressEl.style.width = '5%';
    const script = [
      'loading grid manifest: ' + state.manifest,
      'spawning wasm module (stub)...',
      'allocating buffers...',
      'running ' + state.template + ' ' + state.params.join(' '),
      'computing flows...',
      'serializing Parquet...',
      'done (simulated)'
    ];
    let idx = 0;
    const tick = () => {
      if (idx < script.length) {
        const pct = Math.min(100, 10 + idx * 15);
        progressEl.style.width = pct + '%';
        log('> ' + script[idx]);
        idx += 1;
        setTimeout(tick, 350);
      } else {
        progressEl.style.width = '100%';
        log('status: success (stub)');
      }
    };
    tick();
  });

  updatePreview();
})();
</script>
{% endblock content %}
