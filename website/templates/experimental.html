{% extends "base.html" %}

{% block title %}{{ page.title }} | {{ config.title }}{% endblock title %}
{% block description %}{{ page.description }}{% endblock description %}

{% block extra_head %}
<style>
  /* ═══════════════════════════════════════════════════════════════════════════════
     GAT Experimental UI - Network-Centric Design
     ═══════════════════════════════════════════════════════════════════════════════ */

  :root {
    --exp-bg: radial-gradient(circle at 20% 20%, rgba(234, 88, 12, 0.06), transparent 35%),
              radial-gradient(circle at 80% 0%, rgba(59, 130, 246, 0.08), transparent 30%),
              linear-gradient(135deg, var(--c1, #ffffff), var(--c2, #f8fafc) 60%, var(--c1, #ffffff));
    --panel: var(--c2, #f8fafc);
    --panel-stroke: var(--c3, #e2e8f0);
    --exp-text: var(--f1, #1e293b);
    --exp-heading: var(--f2, #0f172a);
    --accent: var(--a1, #ea580c);
    --accent-glow: rgba(234, 88, 12, 0.3);
    --muted: var(--c4, #64748b);
    --code: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
  }

  [data-theme="dark"], .dark, html.switch {
    --exp-bg: radial-gradient(circle at 20% 20%, rgba(248, 113, 113, 0.1), transparent 35%),
              radial-gradient(circle at 80% 0%, rgba(59, 130, 246, 0.12), transparent 30%),
              linear-gradient(135deg, #0f172a, #0b1220 60%, #0a0f1c);
    --panel: rgba(15, 23, 42, 0.8);
    --panel-stroke: rgba(148, 163, 184, 0.2);
    --exp-text: #e2e8f0;
    --exp-heading: #ffffff;
    --accent: #fb923c;
    --accent-glow: rgba(251, 146, 60, 0.4);
    --muted: #94a3b8;
  }

  body {
    background: var(--exp-bg);
    background-attachment: fixed;
    color: var(--exp-text);
  }

  /* Main Layout - Network Front and Center */
  .exp-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    grid-template-rows: auto 1fr auto;
    gap: 1rem;
    min-height: calc(100vh - 160px);
  }

  @media (max-width: 1200px) {
    .exp-layout {
      grid-template-columns: 1fr;
    }
    .exp-sidebar {
      order: 2;
    }
    .exp-main {
      order: 1;
    }
  }

  /* Sidebar Panel */
  .exp-sidebar {
    grid-row: 1 / 4;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .card {
    background: var(--panel);
    border: 1px solid var(--panel-stroke);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }
  [data-theme="dark"] .card, .dark .card {
    box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  }

  /* Main Content Area */
  .exp-main {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Network Visualization Container - HERO */
  .network-hero {
    flex: 1;
    min-height: 500px;
    background: var(--panel);
    border: 1px solid var(--panel-stroke);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 40px rgba(0,0,0,0.12);
    overflow: hidden;
  }
  [data-theme="dark"] .network-hero {
    box-shadow: 0 12px 50px rgba(0,0,0,0.35);
  }

  .network-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--panel-stroke);
    background: color-mix(in srgb, var(--panel) 80%, transparent);
    backdrop-filter: blur(8px);
  }

  #network-graph {
    flex: 1;
    background: var(--c2, #f1f5f9);
  }
  [data-theme="dark"] #network-graph {
    background: rgba(0,0,0,0.35);
  }

  .network-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem 1rem;
    border-top: 1px solid var(--panel-stroke);
    font-size: 0.85rem;
    color: var(--muted);
  }

  /* Tabbed Feature Panel */
  .feature-tabs {
    background: var(--panel);
    border: 1px solid var(--panel-stroke);
    border-radius: 12px;
    overflow: hidden;
  }

  .tab-bar {
    display: flex;
    border-bottom: 1px solid var(--panel-stroke);
    background: color-mix(in srgb, var(--panel-stroke) 30%, transparent);
    overflow-x: auto;
  }

  .tab-btn {
    padding: 0.75rem 1.25rem;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--muted);
    border: none;
    background: transparent;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s ease;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
  }
  .tab-btn:hover {
    color: var(--exp-text);
    background: color-mix(in srgb, var(--panel-stroke) 20%, transparent);
  }
  .tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
    background: var(--panel);
  }

  .tab-content {
    display: none;
    padding: 1rem;
    max-height: 280px;
    overflow-y: auto;
  }
  .tab-content.active {
    display: block;
  }

  /* Common Components */
  .section-title {
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.72rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .pill {
    display: inline-flex;
    gap: 0.35rem;
    align-items: center;
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    background: var(--panel);
    border: 1px solid var(--panel-stroke);
    font-size: 0.8rem;
    color: var(--muted);
  }

  .signal {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 10px rgba(34,197,94,0.55);
  }

  .badge {
    border-radius: 6px;
    padding: 0.2rem 0.55rem;
    font-size: 0.72rem;
    background: rgba(249, 115, 22, 0.12);
    color: #fdba74;
    border: 1px solid rgba(249, 115, 22, 0.35);
  }

  .stub-input {
    width: 100%;
    background: var(--c1, #ffffff);
    border: 1px solid var(--panel-stroke);
    color: var(--exp-text);
    border-radius: 8px;
    padding: 0.55rem 0.7rem;
    font-family: var(--code);
    font-size: 0.85rem;
  }
  [data-theme="dark"] .stub-input {
    background: rgba(255,255,255,0.03);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.55rem 0.9rem;
    border-radius: 8px;
    border: 1px solid var(--accent);
    background: var(--accent);
    color: white;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .btn:hover {
    box-shadow: 0 4px 16px var(--accent-glow);
  }
  .btn:active {
    transform: scale(0.98);
  }

  .btn.ghost {
    background: var(--panel);
    border-color: var(--panel-stroke);
    color: var(--exp-text);
  }
  [data-theme="dark"] .btn.ghost {
    background: rgba(255,255,255,0.02);
    color: var(--muted);
  }
  .btn.ghost:hover {
    border-color: var(--accent);
    box-shadow: none;
  }

  .btn.sm {
    padding: 0.4rem 0.7rem;
    font-size: 0.78rem;
  }

  .mini-tab {
    display: inline-flex;
    gap: 0.35rem;
    align-items: center;
    padding: 0.35rem 0.65rem;
    border-radius: 6px;
    background: var(--c1, #ffffff);
    border: 1px solid var(--panel-stroke);
    color: var(--exp-text);
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 0.8rem;
  }
  [data-theme="dark"] .mini-tab {
    background: rgba(255,255,255,0.03);
  }
  .mini-tab:hover {
    border-color: var(--accent);
  }
  .mini-tab.active {
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
  }

  .layout-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.55rem;
    background: var(--c1, #ffffff);
    border-radius: 6px;
    border: 1px solid var(--panel-stroke);
    color: var(--exp-text);
    font-size: 0.78rem;
  }
  [data-theme="dark"] .layout-chip {
    background: rgba(255,255,255,0.04);
  }

  .console {
    background: var(--c2, #f1f5f9);
    border: 1px solid var(--panel-stroke);
    border-radius: 8px;
    padding: 0.6rem;
    font-family: var(--code);
    font-size: 0.8rem;
    color: var(--exp-text);
    min-height: 100px;
    max-height: 160px;
    overflow-y: auto;
    line-height: 1.4;
  }
  [data-theme="dark"] .console {
    background: rgba(0,0,0,0.45);
    color: #a5f3fc;
  }

  .codebox {
    font-family: var(--code);
    background: var(--c2, #f1f5f9);
    border: 1px solid var(--panel-stroke);
    border-radius: 8px;
    padding: 0.6rem;
    color: var(--exp-text);
    white-space: pre-wrap;
    word-break: break-word;
    font-size: 0.78rem;
    min-height: 80px;
    max-height: 150px;
    overflow-y: auto;
  }
  [data-theme="dark"] .codebox {
    background: rgba(0,0,0,0.35);
  }

  .prog {
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: var(--panel-stroke);
    overflow: hidden;
  }
  .prog span {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, #f97316, #fb923c);
    width: 0%;
    transition: width 0.2s ease;
  }

  .stack {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .flex-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .canvas-ghost {
    border: 1px dashed var(--panel-stroke);
    border-radius: 8px;
    min-height: 100px;
    background: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 10px,
      color-mix(in srgb, var(--panel-stroke) 20%, transparent) 10px,
      color-mix(in srgb, var(--panel-stroke) 20%, transparent) 20px
    );
    color: var(--muted);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1rem;
    font-size: 0.85rem;
  }

  /* Utilities */
  .text-xs { font-size: 0.75rem; }
  .text-sm { font-size: 0.85rem; }
  .text-muted { color: var(--muted); }
  .mt-2 { margin-top: 0.5rem; }
  .mt-3 { margin-top: 0.75rem; }
  .mb-2 { margin-bottom: 0.5rem; }
  .gap-2 { gap: 0.5rem; }
  .gap-3 { gap: 0.75rem; }
  .flex-1 { flex: 1; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
{% endblock extra_head %}

{% block content %}
<div class="relative z-10">
  {% include "partials/header.html" %}

<section class="container mx-auto px-4 py-6">
  <div class="exp-layout">
    <!-- ═══════════════════════════════════════════════════════════════════════════
         SIDEBAR: Controls & Status
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="exp-sidebar">
      <!-- Status Header -->
      <div class="card">
        <div class="flex-row mb-2">
          <span class="pill"><span class="signal"></span> Live</span>
          <span class="badge" id="wasm-status">WASM loading</span>
        </div>
        <div class="text-sm text-muted">Run power flow analysis entirely in-browser via WebAssembly.</div>
      </div>

      <!-- Case Selection -->
      <div class="card stack">
        <div class="section-title">Test Case</div>
        <select class="stub-input" id="case-select">
          <option value="">-- Select case --</option>
          <option value="ieee14">IEEE 14</option>
          <option value="ieee30">IEEE 30</option>
          <option value="ieee57">IEEE 57</option>
          <option value="ieee118">IEEE 118</option>
        </select>
        <div class="layout-chip" id="file-drop-zone" style="cursor:pointer; justify-content: center;">
          <span>+</span><span>Drop .m file</span>
        </div>
      </div>

      <!-- Analysis Type -->
      <div class="card stack">
        <div class="section-title">Analysis</div>
        <div class="flex-row">
          <span class="mini-tab" data-preset="ed">ED</span>
          <span class="mini-tab active" data-preset="opf-dc">DC OPF</span>
          <span class="mini-tab" data-preset="socp-fast">SOCP Fast</span>
          <span class="mini-tab" data-preset="pf-ac">SOCP</span>
          <span class="mini-tab" data-preset="compare">Compare</span>
        </div>
        <div class="text-xs text-muted" id="method-hint">DC linearized optimal power flow</div>
        <button class="btn" data-action="simulate-run" style="width: 100%; justify-content: center;">
          Run Analysis
        </button>
      </div>

      <!-- Results Summary -->
      <div class="card stack flex-1">
        <div class="section-title">Results</div>
        <div class="prog"><span id="sim-progress"></span></div>
        <div class="codebox" id="intent-preview">{ "status": "waiting" }</div>
        <div class="console" id="sim-console">[idle]</div>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════
         MAIN: Network Visualization
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="exp-main">
      <!-- Network Graph Hero -->
      <div class="network-hero">
        <div class="network-toolbar">
          <div class="flex-row gap-2">
            <span class="mini-tab active" data-layout="preset">Computed</span>
            <span class="mini-tab" data-layout="circle">Circle</span>
            <span class="mini-tab" data-layout="grid">Grid</span>
          </div>
          <div class="flex-row gap-2">
            <button class="btn sm ghost" data-action="fit">Fit</button>
            <button class="btn sm ghost" data-action="center">Center</button>
            <button class="btn sm ghost" data-action="export-spec">Export</button>
          </div>
        </div>
        <div id="network-graph"></div>
        <div class="network-status">
          <span id="network-stats">Select a case to visualize the network</span>
          <span class="flex-1"></span>
          <span class="layout-chip" id="toggle-labels" style="cursor:pointer;">Labels</span>
          <span class="layout-chip" id="toggle-flows" style="cursor:pointer;">Flows</span>
        </div>
      </div>

      <!-- Tabbed Features Panel -->
      <div class="feature-tabs">
        <div class="tab-bar">
          <button class="tab-btn active" data-tab="sql">SQL Query</button>
          <button class="tab-btn" data-tab="data">Data Tables</button>
          <button class="tab-btn" data-tab="gis">GIS Overlay</button>
          <button class="tab-btn" data-tab="pipeline">Pipeline</button>
          <button class="tab-btn" data-tab="collab">Agents</button>
          <button class="tab-btn" data-tab="diag">Diagnostics</button>
        </div>

        <!-- SQL Tab -->
        <div class="tab-content active" data-tab-content="sql">
          <div class="stack">
            <div class="flex-row">
              <span class="mini-tab active" data-query="top-generators">Top Generators</span>
              <span class="mini-tab" data-query="high-lmps">High LMPs</span>
              <span class="mini-tab" data-query="loaded-branches">Loaded Branches</span>
              <span class="mini-tab" data-query="summary">Summary</span>
            </div>
            <textarea class="stub-input" id="sql-input" rows="2" style="resize: vertical;">SELECT gen_id, p_mw, q_mvar FROM opf_generators ORDER BY p_mw DESC LIMIT 10</textarea>
            <div class="flex-row">
              <button class="btn sm" id="run-sql-btn">Run SQL</button>
              <span class="layout-chip" id="sql-status">Tables: (run OPF first)</span>
              <span class="flex-1"></span>
              <span class="layout-chip" id="toggle-arrow" style="cursor:pointer;">Arrow: ON</span>
            </div>
            <div class="codebox" id="sql-results">[SQL results appear here after running OPF]</div>
          </div>
        </div>

        <!-- Data Tables Tab -->
        <div class="tab-content" data-tab-content="data">
          <div class="stack">
            <div class="flex-row">
              <span class="mini-tab active" data-table="generators">Generators</span>
              <span class="mini-tab" data-table="buses">Buses</span>
              <span class="mini-tab" data-table="branches">Branches</span>
              <span class="mini-tab" data-table="network">Network Info</span>
              <span class="flex-1"></span>
              <button class="btn sm" id="export-csv-btn" style="font-size:0.75rem;">Export CSV</button>
            </div>
            <div class="codebox" id="data-table-view" style="max-height: 200px; overflow-y: auto;">[Run analysis to populate data tables]</div>
          </div>
        </div>

        <!-- GIS Tab -->
        <div class="tab-content" data-tab-content="gis">
          <div class="stack">
            <div class="flex-row">
              <span class="layout-chip">Basemap: Dark terrain</span>
              <span class="layout-chip">Geo-join: census tracts</span>
              <span class="layout-chip">Layer: hosting-capacity</span>
            </div>
            <div class="canvas-ghost">
              Geographic overlay coming soon. Map buses as points, branches as lines, with choropleth polygons for hosting capacity.
            </div>
          </div>
        </div>

        <!-- Pipeline Tab -->
        <div class="tab-content" data-tab-content="pipeline">
          <div class="stack">
            <div class="text-sm text-muted mb-2">Compose multi-step analysis workflows:</div>
            <div class="flex-row">
              <span class="layout-chip">Import MATPOWER</span>
              <span class="text-muted">&#8594;</span>
              <span class="layout-chip">DC-OPF</span>
              <span class="text-muted">&#8594;</span>
              <span class="layout-chip">N-1 Sweep</span>
              <span class="text-muted">&#8594;</span>
              <span class="layout-chip">Metrics</span>
            </div>
            <div class="canvas-ghost" style="min-height: 80px;">
              Drag-and-drop pipeline builder coming soon. Export as manifest.json for batch processing.
            </div>
          </div>
        </div>

        <!-- Collab/Agents Tab -->
        <div class="tab-content" data-tab-content="collab">
          <div class="stack">
            <div class="flex-row">
              <span class="layout-chip">Live cursors (planned)</span>
              <span class="layout-chip">Agent suggestions</span>
              <span class="layout-chip">Comment threads</span>
            </div>
            <div class="console" id="agent-console">Agent stream: awaiting MCP hook...</div>
            <div class="flex-row">
              <span class="layout-chip" style="cursor:pointer;">Auto-fix proposals</span>
              <span class="layout-chip" style="cursor:pointer;">Guardrails: read-only</span>
            </div>
          </div>
        </div>

        <!-- Diagnostics Tab -->
        <div class="tab-content" data-tab-content="diag">
          <div class="stack">
            <div class="flex-row">
              <span class="mini-tab active">Solver traces</span>
              <span class="mini-tab">Jacobian heatmap</span>
              <span class="mini-tab">Violations</span>
            </div>
            <div class="canvas-ghost">
              Iteration traces, step lengths, KKT residuals visualization coming soon.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
// ═══════════════════════════════════════════════════════════════════════════════
// GAT WASM Web Demo - Network-Centric UI
// ═══════════════════════════════════════════════════════════════════════════════

import init, {
  list_builtin_cases,
  get_builtin_case,
  run_dc_power_flow,
  run_socp_power_flow,
  run_dc_opf_arrow,
  run_socp_opf_arrow,
  run_socp_opf_fast_arrow,
  run_economic_dispatch,
  compute_layout,
  analyze_network,
  compare_methods
} from '/experimental/pkg/gat_wasm.js';

import * as GatBridge from '/experimental/gat-bridge.js';

// DOM elements
const intentPreview = document.getElementById('intent-preview');
const consoleEl = document.getElementById('sim-console');
const progressEl = document.getElementById('sim-progress');
const caseSelect = document.getElementById('case-select');
const wasmStatus = document.getElementById('wasm-status');
const networkStats = document.getElementById('network-stats');

// Application state
const state = {
  runner: 'wasm',
  preset: 'opf-dc',
  caseContent: null,
  caseName: null,
  wasmReady: false,
  cy: null,
  arrowTables: null,
  duckDbConn: null,
  useArrow: true
};

// ═══════════════════════════════════════════════════════════════════════════════
// Tab Navigation
// ═══════════════════════════════════════════════════════════════════════════════

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tabName = btn.getAttribute('data-tab');
    // Update buttons
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // Update content
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`[data-tab-content="${tabName}"]`)?.classList.add('active');
  });
});

// ═══════════════════════════════════════════════════════════════════════════════
// Console & Progress
// ═══════════════════════════════════════════════════════════════════════════════

function log(line, type = 'info') {
  if (consoleEl.textContent.trim() === '[idle]' || consoleEl.textContent.includes('loading')) {
    consoleEl.textContent = '';
  }
  const prefix = type === 'error' ? '! ' : type === 'success' ? '+ ' : '> ';
  consoleEl.textContent += prefix + line + '\n';
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

function setProgress(pct) {
  progressEl.style.width = pct + '%';
}

function updatePreview(data) {
  intentPreview.textContent = JSON.stringify(data || {
    status: state.caseName ? 'ready' : 'waiting',
    case: state.caseName || null,
    method: state.preset,
    wasmReady: state.wasmReady
  }, null, 2);
}

// ═══════════════════════════════════════════════════════════════════════════════
// Cytoscape Network Visualization
// ═══════════════════════════════════════════════════════════════════════════════

function initCytoscape() {
  if (typeof cytoscape === 'undefined') return null;

  return cytoscape({
    container: document.getElementById('network-graph'),
    style: [
      {
        selector: 'node',
        style: {
          'background-color': '#f97316',
          'label': 'data(label)',
          'width': 24,
          'height': 24,
          'font-size': '11px',
          'color': '#94a3b8',
          'text-valign': 'bottom',
          'text-margin-y': 6,
          'border-width': 2,
          'border-color': '#ea580c'
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 2,
          'line-color': '#64748b',
          'curve-style': 'bezier',
          'opacity': 0.7
        }
      },
      {
        selector: 'node:selected',
        style: {
          'background-color': '#22c55e',
          'border-color': '#16a34a'
        }
      }
    ],
    layout: { name: 'preset' },
    minZoom: 0.2,
    maxZoom: 4
  });
}

function renderNetwork(layoutData) {
  if (!state.cy) {
    state.cy = initCytoscape();
    if (!state.cy) return;
  }

  state.cy.elements().remove();

  const nodes = layoutData.nodes.map(n => ({
    data: { id: String(n.id), label: n.label },
    position: { x: n.x * 4, y: n.y * 4 }
  }));

  const edges = layoutData.edges.map((e, i) => ({
    data: {
      id: 'e' + i,
      source: String(e.source),
      target: String(e.target)
    }
  }));

  state.cy.add([...nodes, ...edges]);
  state.cy.fit(undefined, 30);

  networkStats.textContent = `${nodes.length} buses | ${edges.length} branches`;
}

// ═══════════════════════════════════════════════════════════════════════════════
// WASM Integration
// ═══════════════════════════════════════════════════════════════════════════════

async function initWasm() {
  try {
    consoleEl.textContent = '[WASM loading...]';
    setProgress(10);

    await init();
    setProgress(50);

    const casesJson = list_builtin_cases();
    const cases = JSON.parse(casesJson);
    log('WASM ready');
    log('Cases: ' + cases.join(', '));

    // Populate select
    while (caseSelect.firstChild) caseSelect.removeChild(caseSelect.firstChild);
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = '-- Select case --';
    caseSelect.appendChild(defaultOpt);
    cases.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c.toUpperCase();
      caseSelect.appendChild(opt);
    });

    setProgress(100);
    state.wasmReady = true;
    wasmStatus.textContent = 'WASM ready';
    wasmStatus.style.background = 'rgba(34, 197, 94, 0.12)';
    wasmStatus.style.color = '#86efac';
    wasmStatus.style.borderColor = 'rgba(34, 197, 94, 0.35)';

    updatePreview();

  } catch (err) {
    log('WASM failed: ' + err.message, 'error');
    wasmStatus.textContent = 'WASM error';
    wasmStatus.style.background = 'rgba(239, 68, 68, 0.12)';
    console.error(err);
  }
}

async function loadCase(caseName) {
  if (!state.wasmReady) return;

  try {
    log('Loading ' + caseName + '...');
    setProgress(20);

    state.caseContent = get_builtin_case(caseName);
    state.caseName = caseName;
    setProgress(40);

    state.networkAnalysis = JSON.parse(analyze_network(state.caseContent));
    log(`${state.networkAnalysis.bus_count} buses, ${state.networkAnalysis.branch_count} branches, ${state.networkAnalysis.gen_count} gens`);
    setProgress(60);

    log('Computing layout...');
    const layoutData = JSON.parse(compute_layout(state.caseContent, 150));
    setProgress(80);

    renderNetwork(layoutData);
    setProgress(100);

    log('Ready', 'success');
    updatePreview();

  } catch (err) {
    log('Load failed: ' + err.message, 'error');
    console.error(err);
  }
}

async function runOpf() {
  if (!state.wasmReady || !state.caseContent) {
    log('Select a case first', 'error');
    return;
  }

  try {
    consoleEl.textContent = '';
    log('Running ' + state.preset + '...');
    setProgress(10);

    const startTime = performance.now();
    let result;
    let arrowResult = null;

    if (state.preset === 'ed') {
      log('Economic Dispatch (no network constraints)');
      setProgress(30);
      result = JSON.parse(run_economic_dispatch(state.caseContent));
    } else if (state.useArrow && state.preset === 'opf-dc') {
      log('DC-OPF (Arrow IPC)');
      setProgress(30);
      arrowResult = run_dc_opf_arrow(state.caseContent);
      result = JSON.parse(arrowResult.summary);
    } else if (state.useArrow && state.preset === 'socp-fast') {
      log('SOCP Fast (Arrow IPC, relaxed tolerances)');
      setProgress(30);
      arrowResult = run_socp_opf_fast_arrow(state.caseContent);
      result = JSON.parse(arrowResult.summary);
    } else if (state.useArrow && state.preset === 'pf-ac') {
      log('SOCP (Arrow IPC)');
      setProgress(30);
      arrowResult = run_socp_opf_arrow(state.caseContent);
      result = JSON.parse(arrowResult.summary);
    } else if (state.preset === 'compare') {
      log('Comparing all methods...');
      setProgress(30);
      result = JSON.parse(compare_methods(state.caseContent));
    } else {
      log('DC Power Flow');
      setProgress(30);
      result = JSON.parse(run_dc_power_flow(state.caseContent));
    }

    setProgress(70);
    const elapsed = (performance.now() - startTime).toFixed(1);

    // Process Arrow results
    if (arrowResult) {
      try {
        await GatBridge.initArrow();
        state.arrowTables = {
          generators: GatBridge.parseArrowIPC(arrowResult.generators),
          buses: GatBridge.parseArrowIPC(arrowResult.buses),
          branches: GatBridge.parseArrowIPC(arrowResult.branches),
          summary: result
        };
        arrowResult.free();
        log('Arrow tables ready', 'success');

        try {
          state.duckDbConn = await GatBridge.registerInDuckDB(state.arrowTables, 'opf');
          log('DuckDB ready', 'success');
          document.getElementById('sql-status').textContent = 'Tables: generators, buses, branches';
        } catch (dbErr) {
          log('DuckDB: ' + dbErr.message);
        }
      } catch (arrowErr) {
        log('Arrow: ' + arrowErr.message, 'error');
      }
    }

    setProgress(90);

    // Display results
    if (state.preset === 'compare') {
      log('Comparison complete', 'success');
      // Show comparison summary
      if (result.dc_opf) log(`DC-OPF: $${result.dc_opf.objective?.toFixed(2)}/hr (${result.dc_opf.solve_time_ms?.toFixed(1)}ms)`);
      if (result.socp) log(`SOCP: $${result.socp.objective?.toFixed(2)}/hr (${result.socp.solve_time_ms?.toFixed(1)}ms)`);
      if (result.economic_dispatch) log(`ED: $${result.economic_dispatch.objective?.toFixed(2)}/hr (${result.economic_dispatch.solve_time_ms?.toFixed(1)}ms)`);
      updatePreview(result);
    } else if (state.preset === 'ed') {
      const obj = result.total_cost || result.objective;
      log('ED Complete: $' + (obj?.toFixed?.(2) || 'N/A') + '/hr', 'success');
      log('Time: ' + elapsed + 'ms');
      if (result.total_generation_mw) {
        log('Generation: ' + result.total_generation_mw.toFixed(1) + ' MW');
      }
      updatePreview({
        status: 'complete',
        objective: obj,
        solve_time_ms: parseFloat(elapsed),
        case: state.caseName,
        method: 'economic_dispatch',
        total_generation_mw: result.total_generation_mw
      });
    } else if (result.converged || result.status === 'optimal' || result.status === 'converged') {
      const obj = result.objective_value || result.objective;
      log('Converged: $' + (obj?.toFixed?.(2) || 'N/A') + '/hr', 'success');
      log('Time: ' + elapsed + 'ms');

      if (result.total_generation_mw) {
        log('Generation: ' + result.total_generation_mw.toFixed(1) + ' MW');
      }

      updatePreview({
        status: 'converged',
        objective: obj,
        solve_time_ms: parseFloat(elapsed),
        case: state.caseName,
        method: state.preset,
        sql_enabled: !!state.duckDbConn
      });
    } else {
      log('Status: ' + (result.status || 'unknown'), 'error');
    }

    setProgress(100);

    // Auto-populate data tables
    if (state.arrowTables) {
      renderDataTable(state.currentDataTable);
    }

  } catch (err) {
    log('Failed: ' + err.message, 'error');
    console.error(err);
    setProgress(0);
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// SQL Console
// ═══════════════════════════════════════════════════════════════════════════════

const sqlPresets = {
  'top-generators': 'SELECT gen_id, p_mw, q_mvar FROM opf_generators ORDER BY p_mw DESC LIMIT 10',
  'high-lmps': 'SELECT bus_id, lmp, v_mag FROM opf_buses WHERE lmp IS NOT NULL ORDER BY lmp DESC LIMIT 10',
  'loaded-branches': 'SELECT branch_id, ABS(p_flow_mw) as flow_mw FROM opf_branches ORDER BY ABS(p_flow_mw) DESC LIMIT 10',
  'summary': 'SELECT COUNT(*) as n_buses, AVG(v_mag) as avg_v, AVG(lmp) as avg_lmp FROM opf_buses'
};

document.querySelectorAll('[data-query]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-query]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const sqlInput = document.getElementById('sql-input');
    if (sqlInput) sqlInput.value = sqlPresets[btn.getAttribute('data-query')] || '';
  });
});

document.getElementById('run-sql-btn')?.addEventListener('click', async () => {
  const sqlInput = document.getElementById('sql-input');
  const sqlResults = document.getElementById('sql-results');

  if (!state.duckDbConn) {
    sqlResults.textContent = 'Run OPF first to enable SQL queries';
    return;
  }

  const sql = sqlInput.value.trim();
  if (!sql) return;

  try {
    sqlResults.textContent = 'Running...';
    log('SQL: ' + sql.substring(0, 40) + '...');
    const results = await GatBridge.querySql(state.duckDbConn, sql);

    if (results?.length > 0) {
      const cols = Object.keys(results[0]);
      let output = cols.join(' | ') + '\n' + cols.map(() => '---').join(' | ') + '\n';
      results.forEach(row => {
        output += cols.map(c => {
          const v = row[c];
          return typeof v === 'number' ? v.toFixed(4) : v;
        }).join(' | ') + '\n';
      });
      sqlResults.textContent = output;
      document.getElementById('sql-status').textContent = `Tables: gen, bus, branch | ${results.length} rows`;
      log(results.length + ' rows', 'success');
    } else {
      sqlResults.textContent = 'No results';
    }
  } catch (err) {
    sqlResults.textContent = 'Error: ' + err.message;
    log('SQL error: ' + err.message, 'error');
  }
});

// Arrow mode toggle
document.getElementById('toggle-arrow')?.addEventListener('click', function() {
  state.useArrow = !state.useArrow;
  this.textContent = 'Arrow: ' + (state.useArrow ? 'ON' : 'OFF');
});

// ═══════════════════════════════════════════════════════════════════════════════
// Data Tables & Network Analysis
// ═══════════════════════════════════════════════════════════════════════════════

// Store network analysis results
state.networkAnalysis = null;
state.currentDataTable = 'generators';

function renderDataTable(tableName) {
  const view = document.getElementById('data-table-view');
  state.currentDataTable = tableName;

  // Update active tab
  document.querySelectorAll('[data-table]').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-table="${tableName}"]`)?.classList.add('active');

  // Handle network info tab (uses analyze_network)
  if (tableName === 'network') {
    if (!state.networkAnalysis) {
      view.textContent = state.caseContent
        ? 'Click "Run Analysis" to compute network statistics'
        : 'Select a case first';
      return;
    }
    const a = state.networkAnalysis;
    view.innerHTML = `<table style="width:100%; font-size:0.8rem;">
      <tr><td style="padding:4px 8px;"><b>Buses</b></td><td>${a.bus_count}</td></tr>
      <tr><td style="padding:4px 8px;"><b>Generators</b></td><td>${a.gen_count}</td></tr>
      <tr><td style="padding:4px 8px;"><b>Branches</b></td><td>${a.branch_count}</td></tr>
      <tr><td style="padding:4px 8px;"><b>Total Gen Capacity</b></td><td>${a.total_gen_capacity_mw?.toFixed(1) || 'N/A'} MW</td></tr>
      <tr><td style="padding:4px 8px;"><b>Total Load</b></td><td>${a.total_load_mw?.toFixed(1) || 'N/A'} MW</td></tr>
      <tr><td style="padding:4px 8px;"><b>Capacity Margin</b></td><td>${((a.total_gen_capacity_mw - a.total_load_mw) / a.total_load_mw * 100)?.toFixed(1) || 'N/A'}%</td></tr>
      <tr><td style="padding:4px 8px;"><b>Areas</b></td><td>${a.area_count || 1}</td></tr>
      <tr><td style="padding:4px 8px;"><b>Voltage Levels</b></td><td>${a.voltage_levels?.join(', ') || 'N/A'} kV</td></tr>
    </table>`;
    return;
  }

  // Handle OPF result tables
  if (!state.arrowTables) {
    view.textContent = '[Run analysis to populate data tables]';
    return;
  }

  const table = state.arrowTables[tableName];
  if (!table) {
    view.textContent = `No ${tableName} data available`;
    return;
  }

  // Convert Arrow table to HTML
  const fields = table.schema.fields;
  let html = '<table style="width:100%; font-size:0.78rem; border-collapse: collapse;">';
  html += '<thead><tr style="border-bottom:1px solid var(--panel-stroke);">';
  for (const f of fields) {
    html += `<th style="padding:4px 6px; text-align:left; font-weight:600;">${f.name}</th>`;
  }
  html += '</tr></thead><tbody>';

  let count = 0;
  for (const row of table) {
    if (count >= 50) break;
    html += '<tr style="border-bottom:1px solid var(--panel-stroke); opacity:0.9;">';
    for (const f of fields) {
      const v = row[f.name];
      const formatted = typeof v === 'number' ? v.toFixed(4) : v;
      html += `<td style="padding:3px 6px;">${formatted}</td>`;
    }
    html += '</tr>';
    count++;
  }

  html += '</tbody></table>';
  if (table.numRows > 50) {
    html += `<div style="padding:4px; font-size:0.75rem; color:var(--muted);">Showing 50 of ${table.numRows} rows</div>`;
  }
  view.innerHTML = html;
}

// Data table tab clicks
document.querySelectorAll('[data-table]').forEach(btn => {
  btn.addEventListener('click', () => renderDataTable(btn.getAttribute('data-table')));
});

// CSV Export functionality
document.getElementById('export-csv-btn')?.addEventListener('click', () => {
  if (!state.arrowTables) {
    log('No data to export. Run analysis first.', 'error');
    return;
  }

  const tableName = state.currentDataTable === 'network' ? 'generators' : state.currentDataTable;
  const table = state.arrowTables[tableName];
  if (!table) return;

  const fields = table.schema.fields;
  let csv = fields.map(f => f.name).join(',') + '\n';

  for (const row of table) {
    const values = fields.map(f => {
      const v = row[f.name];
      return typeof v === 'number' ? v.toFixed(6) : v;
    });
    csv += values.join(',') + '\n';
  }

  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `opf_${tableName}_${state.caseName || 'results'}.csv`;
  a.click();
  log(`Exported ${tableName} as CSV`, 'success');
});

// ═══════════════════════════════════════════════════════════════════════════════
// Event Handlers
// ═══════════════════════════════════════════════════════════════════════════════

caseSelect.addEventListener('change', e => {
  if (e.target.value) loadCase(e.target.value);
});

const methodHints = {
  'ed': 'Merit-order dispatch without network constraints (fastest)',
  'opf-dc': 'DC linearized optimal power flow',
  'socp-fast': 'SOCP with relaxed tolerances (50-70% faster)',
  'pf-ac': 'SOCP convex relaxation (more accurate)',
  'compare': 'Compare all methods side-by-side'
};

document.querySelectorAll('[data-preset]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.preset = btn.getAttribute('data-preset');
    document.getElementById('method-hint').textContent = methodHints[state.preset] || '';
    updatePreview();
  });
});

document.querySelector('[data-action="simulate-run"]')?.addEventListener('click', runOpf);

document.querySelectorAll('[data-layout]').forEach(btn => {
  btn.addEventListener('click', () => {
    if (!state.cy || state.cy.elements().length === 0) return;
    document.querySelectorAll('[data-layout]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const layout = btn.getAttribute('data-layout');
    if (layout === 'preset' && state.caseContent) {
      const layoutData = JSON.parse(compute_layout(state.caseContent, 150));
      renderNetwork(layoutData);
    } else {
      state.cy.layout({ name: layout, animate: true }).run();
    }
  });
});

document.querySelector('[data-action="fit"]')?.addEventListener('click', () => state.cy?.fit(undefined, 30));
document.querySelector('[data-action="center"]')?.addEventListener('click', () => state.cy?.center());

document.querySelector('[data-action="export-spec"]')?.addEventListener('click', () => {
  const blob = new Blob([intentPreview.textContent], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'gat-results.json';
  a.click();
});

// File drop zone
const dropZone = document.getElementById('file-drop-zone');
if (dropZone) {
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; });
  dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = ''; });
  dropZone.addEventListener('drop', async e => {
    e.preventDefault();
    dropZone.style.borderColor = '';
    const file = e.dataTransfer.files[0];
    if (file?.name.endsWith('.m')) {
      state.caseContent = await file.text();
      state.caseName = file.name;
      caseSelect.value = '';
      log('Loaded: ' + file.name);
      try {
        const analysis = JSON.parse(analyze_network(state.caseContent));
        log(`${analysis.bus_count} buses, ${analysis.branch_count} branches`);
        const layoutData = JSON.parse(compute_layout(state.caseContent, 150));
        renderNetwork(layoutData);
        log('Ready', 'success');
        updatePreview();
      } catch (err) {
        log('Parse error: ' + err.message, 'error');
      }
    }
  });
  dropZone.addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.m';
    input.onchange = async e => {
      const file = e.target.files[0];
      if (file) {
        state.caseContent = await file.text();
        state.caseName = file.name;
        caseSelect.value = '';
        log('Loaded: ' + file.name);
        try {
          const analysis = JSON.parse(analyze_network(state.caseContent));
          log(`${analysis.bus_count} buses, ${analysis.branch_count} branches`);
          const layoutData = JSON.parse(compute_layout(state.caseContent, 150));
          renderNetwork(layoutData);
          log('Ready', 'success');
          updatePreview();
        } catch (err) {
          log('Parse error: ' + err.message, 'error');
        }
      }
    };
    input.click();
  });
}

// ═══════════════════════════════════════════════════════════════════════════════
// Initialize
// ═══════════════════════════════════════════════════════════════════════════════

updatePreview();
initWasm();
</script>

  {% include "partials/footer.html" %}
</div>
{% endblock content %}
