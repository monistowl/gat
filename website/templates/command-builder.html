{% extends "base.html" %}

{% block title %}{{ page.title }} | {{ config.title }}{% endblock title %}
{% block description %}{{ page.description }}{% endblock description %}

{% block extra_head %}
<script>
const COMMANDS = {
  pf_dc: {
    name: "DC Power Flow",
    icon: "‚ö°",
    description: "Fast linearized power flow analysis",
    template: "gat pf dc",
    params: [
      { id: "input", label: "Input Grid File", type: "text", required: true, default: "grid.arrow", help: "Arrow/Parquet file with network data" },
      { id: "out", label: "Output File", type: "text", required: true, flag: "--out", default: "flows.parquet", help: "Where to save results" },
      { id: "solver", label: "Solver", type: "select", flag: "--solver", options: ["gauss", "faer"], help: "Linear solver backend" },
      { id: "threads", label: "Threads", type: "number", flag: "--threads", help: "Number of parallel threads (auto by default)" }
    ]
  },
  pf_ac: {
    name: "AC Power Flow",
    icon: "‚ö°",
    description: "Full nonlinear AC power flow with Newton-Raphson",
    template: "gat pf ac",
    params: [
      { id: "input", label: "Input Grid File", type: "text", required: true, default: "grid.arrow" },
      { id: "out", label: "Output File", type: "text", required: true, flag: "--out", default: "flows.parquet" },
      { id: "tol", label: "Tolerance", type: "number", flag: "--tol", default: "1e-6", help: "Convergence tolerance" },
      { id: "max-iter", label: "Max Iterations", type: "number", flag: "--max-iter", default: "20", help: "Maximum Newton iterations" },
      { id: "solver", label: "Solver", type: "select", flag: "--solver", options: ["gauss", "faer"] }
    ]
  },
  opf_dc: {
    name: "DC Optimal Power Flow",
    icon: "üéØ",
    description: "Economic dispatch with linearized power flow",
    template: "gat opf dc",
    params: [
      { id: "input", label: "Input Grid File", type: "text", required: true, default: "grid.arrow" },
      { id: "cost", label: "Cost File", type: "text", required: true, flag: "--cost", default: "costs.csv", help: "CSV with gen_id,cost_per_mw" },
      { id: "limits", label: "Limits File", type: "text", flag: "--limits", default: "limits.csv", help: "CSV with gen_id,p_min,p_max" },
      { id: "out", label: "Output File", type: "text", required: true, flag: "--out", default: "dispatch.parquet" },
      { id: "solver", label: "Solver", type: "select", flag: "--solver", options: ["clarabel", "highs", "cbc"] }
    ]
  },
  opf_ac: {
    name: "AC Optimal Power Flow",
    icon: "üéØ",
    description: "Full AC OPF with reactive power optimization",
    template: "gat opf ac",
    params: [
      { id: "input", label: "Input Grid File", type: "text", required: true, default: "grid.arrow" },
      { id: "cost", label: "Cost File", type: "text", required: true, flag: "--cost", default: "costs.csv" },
      { id: "limits", label: "Limits File", type: "text", flag: "--limits", default: "limits.csv" },
      { id: "out", label: "Output File", type: "text", required: true, flag: "--out", default: "dispatch.parquet" },
      { id: "tol", label: "Tolerance", type: "number", flag: "--tol", default: "1e-6" },
      { id: "max-iter", label: "Max Iterations", type: "number", flag: "--max-iter", default: "20" }
    ]
  },
  contingency: {
    name: "N-1 Contingency Analysis",
    icon: "üîç",
    description: "Screen system for reliability violations",
    template: "gat contingency n1",
    params: [
      { id: "input", label: "Input Grid File", type: "text", required: true, default: "grid.arrow" },
      { id: "out", label: "Output File", type: "text", required: true, flag: "--out", default: "violations.parquet" },
      { id: "parallel", label: "Parallel Execution", type: "checkbox", flag: "--parallel", help: "Run contingencies in parallel" },
      { id: "limit-violations", label: "Violation Threshold", type: "number", flag: "--limit-violations", default: "0.95", help: "Flag violations above this p.u." }
    ]
  },
  ts_resample: {
    name: "Time Series Resampling",
    icon: "üìà",
    description: "Resample time series data to different frequency",
    template: "gat ts resample",
    params: [
      { id: "input", label: "Input Time Series", type: "text", required: true, default: "timeseries.parquet" },
      { id: "freq", label: "Frequency", type: "select", required: true, flag: "--freq", options: ["1min", "5min", "15min", "1h", "1d"], help: "Target sampling frequency" },
      { id: "agg", label: "Aggregation", type: "select", required: true, flag: "--agg", options: ["mean", "sum", "min", "max", "first", "last"] },
      { id: "out", label: "Output File", type: "text", required: true, flag: "--out", default: "resampled.parquet" }
    ]
  },
  batch_pf: {
    name: "Batch Power Flow",
    icon: "üîÑ",
    description: "Run power flow on multiple scenarios",
    template: "gat batch pf",
    params: [
      { id: "manifest", label: "Manifest File", type: "text", required: true, flag: "--manifest", default: "scenarios.json", help: "JSON with scenario list" },
      { id: "out", label: "Output Directory", type: "text", required: true, flag: "--out", default: "results/" },
      { id: "parallel", label: "Parallel Jobs", type: "number", flag: "--parallel", default: "4", help: "Number of concurrent scenarios" }
    ]
  },
  derms_aggregate: {
    name: "DER Aggregation",
    icon: "üîã",
    description: "Aggregate distributed energy resources",
    template: "gat derms aggregate",
    params: [
      { id: "input", label: "DER Data File", type: "text", required: true, default: "ders.parquet" },
      { id: "method", label: "Method", type: "select", required: true, flag: "--method", options: ["envelope", "centroid"], help: "Aggregation methodology" },
      { id: "out", label: "Output File", type: "text", required: true, flag: "--out", default: "aggregated.parquet" }
    ]
  }
};

function buildCommand(cmdKey) {
  const cmd = COMMANDS[cmdKey];
  let parts = [cmd.template];

  cmd.params.forEach(param => {
    const elem = document.getElementById(`param-${param.id}`);
    if (!elem) return;

    let value = null;

    if (param.type === 'checkbox') {
      if (elem.checked && param.flag) {
        parts.push(param.flag);
      }
    } else {
      value = elem.value.trim();

      if (value) {
        if (param.flag) {
          parts.push(`${param.flag} ${value}`);
        } else {
          // Positional argument
          parts.push(value);
        }
      }
    }
  });

  return parts.join(' ');
}

function copyCommand() {
  const command = document.getElementById('commandPreview').textContent;
  navigator.clipboard.writeText(command);

  const btn = document.getElementById('copyBtn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚úÖ Copied!';
  setTimeout(() => {
    btn.innerHTML = originalText;
  }, 2000);
}
</script>
{% endblock extra_head %}

{% block content %}
<div class="relative z-10">
  {% include "partials/header.html" %}

  <div class="max-w-7xl mx-auto px-6 py-12">
    <!-- Header -->
    <div class="mb-12">
      {{ page.content | safe }}
    </div>

    <!-- Command Type Selection -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Select Command Type</h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
        <button onclick="loadCommand('pf_dc')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">‚ö°</div>
          <h3 class="text-lg font-bold text-white mb-1">DC Power Flow</h3>
          <p class="text-slate-400 text-sm">Fast linearized analysis</p>
        </button>

        <button onclick="loadCommand('pf_ac')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">‚ö°</div>
          <h3 class="text-lg font-bold text-white mb-1">AC Power Flow</h3>
          <p class="text-slate-400 text-sm">Full nonlinear AC</p>
        </button>

        <button onclick="loadCommand('opf_dc')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">üéØ</div>
          <h3 class="text-lg font-bold text-white mb-1">DC OPF</h3>
          <p class="text-slate-400 text-sm">Economic dispatch</p>
        </button>

        <button onclick="loadCommand('opf_ac')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">üéØ</div>
          <h3 class="text-lg font-bold text-white mb-1">AC OPF</h3>
          <p class="text-slate-400 text-sm">Full AC optimization</p>
        </button>

        <button onclick="loadCommand('contingency')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">üîç</div>
          <h3 class="text-lg font-bold text-white mb-1">N-1 Contingency</h3>
          <p class="text-slate-400 text-sm">Reliability screening</p>
        </button>

        <button onclick="loadCommand('ts_resample')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">üìà</div>
          <h3 class="text-lg font-bold text-white mb-1">Time Series</h3>
          <p class="text-slate-400 text-sm">Resample data</p>
        </button>

        <button onclick="loadCommand('batch_pf')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">üîÑ</div>
          <h3 class="text-lg font-bold text-white mb-1">Batch Analysis</h3>
          <p class="text-slate-400 text-sm">Multiple scenarios</p>
        </button>

        <button onclick="loadCommand('derms_aggregate')" class="bg-slate-900/40 border border-slate-800 rounded-lg p-6 card-hover group text-left">
          <div class="text-3xl mb-3">üîã</div>
          <h3 class="text-lg font-bold text-white mb-1">DER Analysis</h3>
          <p class="text-slate-400 text-sm">Aggregate resources</p>
        </button>
      </div>
    </div>

    <!-- Command Builder Interface -->
    <div id="builderInterface" class="hidden">
      <!-- Command Header -->
      <div class="mb-8 p-6 bg-slate-900/60 border border-slate-700 rounded-lg">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div id="cmdIcon" class="text-4xl"></div>
            <div>
              <h2 id="cmdName" class="text-2xl font-bold text-white"></h2>
              <p id="cmdDescription" class="text-slate-400 text-sm"></p>
            </div>
          </div>
          <button
            id="changeBtn"
            onclick="resetBuilder()"
            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded font-medium transition-colors text-sm whitespace-nowrap"
          >
            ‚Üê Change
          </button>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Form Panel -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Required Fields Section -->
          <div id="requiredSection" class="bg-slate-900/60 border border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
              <span class="text-orange-500">*</span>
              Required Parameters
            </h3>
            <div id="requiredFields" class="space-y-4"></div>
          </div>

          <!-- Optional Fields Section -->
          <div id="optionalSection" class="bg-slate-900/60 border border-slate-700 rounded-lg p-6">
            <div class="flex items-center justify-between mb-4 cursor-pointer" onclick="toggleOptional()">
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                ‚öôÔ∏è Optional Parameters
              </h3>
              <span id="optionalToggle" class="text-slate-400">‚ñº</span>
            </div>
            <div id="optionalFields" class="space-y-4"></div>
          </div>

          <!-- Validation Feedback -->
          <div id="validationFeedback" class="hidden p-4 bg-yellow-900/30 border border-yellow-700 rounded-lg">
            <p class="text-sm text-yellow-200" id="validationMessage"></p>
          </div>
        </div>

        <!-- Preview & Actions Panel -->
        <div class="lg:col-span-1">
          <div class="bg-slate-900/60 border border-slate-700 rounded-lg p-6 sticky top-24 space-y-4">
            <div>
              <h3 class="text-lg font-bold text-white mb-4">Command Preview</h3>
              <pre class="bg-slate-950 border border-slate-800 rounded-lg p-4 overflow-x-auto mb-4 max-h-40 text-xs"><code id="commandPreview" class="text-green-400 font-mono"></code></pre>
            </div>

            <div class="space-y-3">
              <button
                id="copyBtn"
                onclick="copyCommand()"
                class="w-full px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded font-medium transition-colors text-sm"
              >
                üìã Copy to Clipboard
              </button>

              <button
                id="executeBtn"
                onclick="showExecutionGuide()"
                class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded font-medium transition-colors text-sm"
              >
                ‚ñ∂ How to Run
              </button>
            </div>

            <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700 text-xs text-slate-400 space-y-2">
              <div>
                <span class="text-orange-400 font-medium">Input Files:</span>
                <span id="inputFileHint" class="text-slate-500"></span>
              </div>
              <div>
                <span class="text-orange-400 font-medium">Output:</span>
                <span id="outputFileHint" class="text-slate-500"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Execution Guide Modal (Hidden) -->
      <div id="executionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-40 p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-lg max-w-md w-full p-6">
          <h3 class="text-xl font-bold text-white mb-4">How to Run This Command</h3>
          <ol class="space-y-3 text-sm text-slate-300">
            <li class="flex gap-3">
              <span class="text-orange-500 font-bold">1.</span>
              <span>Copy the command using the button above</span>
            </li>
            <li class="flex gap-3">
              <span class="text-orange-500 font-bold">2.</span>
              <span>Prepare your input files (see hints in the preview panel)</span>
            </li>
            <li class="flex gap-3">
              <span class="text-orange-500 font-bold">3.</span>
              <span>Open your terminal and paste the command</span>
            </li>
            <li class="flex gap-3">
              <span class="text-orange-500 font-bold">4.</span>
              <span>Press Enter to execute</span>
            </li>
            <li class="flex gap-3">
              <span class="text-orange-500 font-bold">5.</span>
              <span>Check output files in your current directory</span>
            </li>
          </ol>
          <button
            onclick="closeExecutionModal()"
            class="mt-6 w-full px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded font-medium transition-colors"
          >
            Got it, close
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
let currentCommand = null;
let optionalCollapsed = false;

function loadCommand(cmdKey) {
  currentCommand = cmdKey;
  const cmd = COMMANDS[cmdKey];

  document.getElementById('cmdIcon').textContent = cmd.icon;
  document.getElementById('cmdName').textContent = cmd.name;
  document.getElementById('cmdDescription').textContent = cmd.description;

  // Build form - separate required and optional
  const requiredContainer = document.getElementById('requiredFields');
  const optionalContainer = document.getElementById('optionalFields');
  requiredContainer.innerHTML = '';
  optionalContainer.innerHTML = '';

  cmd.params.forEach(param => {
    const div = document.createElement('div');
    div.className = 'field-group';

    const label = document.createElement('label');
    label.className = 'block text-sm font-medium text-slate-300 mb-2';
    label.textContent = param.label;
    if (param.required) {
      const req = document.createElement('span');
      req.className = 'text-orange-500';
      req.textContent = ' *';
      label.appendChild(req);
    }
    div.appendChild(label);

    if (param.type === 'text' || param.type === 'number') {
      const input = document.createElement('input');
      input.type = param.type;
      input.id = `param-${param.id}`;
      input.className = 'w-full bg-slate-950 border border-slate-700 rounded px-4 py-2 text-white focus:border-orange-500 focus:outline-none transition-colors';
      input.placeholder = param.default || '';
      if (param.default) input.value = param.default;
      input.oninput = updatePreview;
      div.appendChild(input);
    } else if (param.type === 'select') {
      const select = document.createElement('select');
      select.id = `param-${param.id}`;
      select.className = 'w-full bg-slate-950 border border-slate-700 rounded px-4 py-2 text-white focus:border-orange-500 focus:outline-none transition-colors';

      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = '-- Select --';
      select.appendChild(emptyOption);

      param.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        if (param.default === opt) option.selected = true;
        select.appendChild(option);
      });

      select.onchange = updatePreview;
      div.appendChild(select);
    } else if (param.type === 'checkbox') {
      const checkLabel = document.createElement('label');
      checkLabel.className = 'flex items-center text-slate-300 cursor-pointer gap-2';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `param-${param.id}`;
      checkbox.className = 'w-4 h-4 accent-orange-500 cursor-pointer';
      checkbox.onchange = updatePreview;

      checkLabel.appendChild(checkbox);
      checkLabel.appendChild(document.createTextNode(param.label));

      div.innerHTML = '';
      div.appendChild(checkLabel);
    }

    if (param.help) {
      const help = document.createElement('p');
      help.className = 'text-xs text-slate-500 mt-1';
      help.textContent = param.help;
      div.appendChild(help);
    }

    if (param.required) {
      requiredContainer.appendChild(div);
    } else {
      optionalContainer.appendChild(div);
    }
  });

  // Hide optional section if empty
  const optionalCount = optionalContainer.children.length;
  if (optionalCount === 0) {
    document.getElementById('optionalSection').classList.add('hidden');
  } else {
    document.getElementById('optionalSection').classList.remove('hidden');
  }

  document.getElementById('builderInterface').classList.remove('hidden');
  optionalCollapsed = false;
  document.getElementById('optionalToggle').textContent = '‚ñº';
  document.getElementById('optionalFields').style.display = 'grid';
  updatePreview();

  // Scroll to builder
  document.getElementById('builderInterface').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function toggleOptional() {
  optionalCollapsed = !optionalCollapsed;
  const toggle = document.getElementById('optionalToggle');
  const fields = document.getElementById('optionalFields');

  if (optionalCollapsed) {
    toggle.textContent = '‚ñ∂';
    fields.style.display = 'none';
  } else {
    toggle.textContent = '‚ñº';
    fields.style.display = 'grid';
  }
}

function updatePreview() {
  if (!currentCommand) return;
  const command = buildCommand(currentCommand);
  const cmd = COMMANDS[currentCommand];

  document.getElementById('commandPreview').textContent = command;

  // Update file hints
  const inputFiles = [];
  const outputFiles = [];

  cmd.params.forEach(param => {
    if (param.id === 'input' || param.id === 'manifest' || param.id === 'cost' || param.id === 'limits') {
      const elem = document.getElementById(`param-${param.id}`);
      if (elem?.value) inputFiles.push(elem.value);
    }
    if (param.id === 'out' && param.flag === '--out') {
      const elem = document.getElementById(`param-${param.id}`);
      if (elem?.value) outputFiles.push(elem.value);
    }
  });

  document.getElementById('inputFileHint').textContent = inputFiles.length > 0 ? inputFiles.join(', ') : 'See form above';
  document.getElementById('outputFileHint').textContent = outputFiles.length > 0 ? outputFiles.join(', ') : 'See form above';

  // Validation feedback
  const requiredFields = Array.from(document.querySelectorAll('.field-group')).filter((group, idx) => {
    const parent = group.parentElement;
    return parent.id === 'requiredFields';
  });

  const allValid = requiredFields.every(group => {
    const input = group.querySelector('input:not([type="checkbox"]), select');
    return input && input.value.trim();
  });

  const feedback = document.getElementById('validationFeedback');
  if (!allValid) {
    feedback.classList.remove('hidden');
    document.getElementById('validationMessage').textContent = '‚ö† Fill in all required fields (*) to build the command';
  } else {
    feedback.classList.add('hidden');
  }
}

function resetBuilder() {
  document.getElementById('builderInterface').classList.add('hidden');
  document.querySelector('.grid.md\\:grid-cols-2').scrollIntoView({ behavior: 'smooth' });
  currentCommand = null;
}

function showExecutionGuide() {
  document.getElementById('executionModal').classList.remove('hidden');
}

function closeExecutionModal() {
  document.getElementById('executionModal').classList.add('hidden');
}

// Close modal on outside click
document.addEventListener('click', function(event) {
  const modal = document.getElementById('executionModal');
  if (event.target === modal) {
    closeExecutionModal();
  }
});
</script>
{% endblock content %}
